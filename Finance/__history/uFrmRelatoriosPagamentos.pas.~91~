unit uFrmRelatoriosPagamentos;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet, uDMOrganizacao, FireDAC.Comp.Client, FireDAC.UI.Intf, FireDAC.Comp.ScriptCommands, uDMContasPagar, udmConexao, FireDAC.Stan.Util, FireDAC.Comp.Script,
  Vcl.Grids, Vcl.DBGrids, frxClass, frxDBSet, frxExportPDF, frxExportCSV, uUtil, Vcl.Buttons, ComObj;

  //uDM está aqui temporariamente

type
  TfrmRelatorioPagamentos = class(TForm)
    dtDataInicial: TDateTimePicker;
    dtDataFinal: TDateTimePicker;
    cbxCentrosCusto: TComboBox;
    cbxStatus: TComboBox;
    cbxOrdem: TComboBox;
    btnConsultar: TButton;
    DBGridMain: TDBGrid;
    Label2: TLabel;
    Label3: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    frxRelContasPagar: TfrxReport;
    frxDBTitulos: TfrxDBDataset;
    frxDBCentroCusto: TfrxDBDataset;
    frxCSVExport1: TfrxCSVExport;
    frxPDFExport1: TfrxPDFExport;
    btnImprimir: TBitBtn;
    cbxTipoRelatorio: TComboBox;
    Label1: TLabel;
    frxDBHistorico: TfrxDBDataset;
    frxDBTitulosExcel: TfrxDBDataset;
    frxReportExcel: TfrxReport;
    btnExcel: TBitBtn;
    statusBar2: TStatusBar;
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure btnImprimirClick(Sender: TObject);
    procedure btnConsultarClick(Sender: TObject);
    procedure btnExcelClick(Sender: TObject);
  private
    { Private declarations }
    FsListaIdOrganizacoes: TStringList;
    FsListaIdCentrosCusto: TStringList;
    procedure inicializarDM(Sender: TObject);
    procedure freeAndNilDM(Sender: TObject);
    function carregarCentrosCusto: Boolean;
    procedure preencherListaCentrosCusto;
    function montarSQL: Boolean;
    function retornarCampoOrdenacao: string;
    procedure exibirRelatorio(tipo: Integer);
    procedure inicializarVariaveisRelatorio;
    function validarFormulario: boolean;
    procedure carregarDadosEmpresa;
    function retornarCaminhoRelatorio(tipo: Integer): string;
    procedure exibirRelatorioExcel(tipo: Integer);
    procedure exibirValoresPanel;
  public
    { Public declarations }
    procedure preencherListaOrganizacoes;
    function carregarDadosPagamentos: boolean;
  end;

var
  frmRelatorioPagamentos: TfrmRelatorioPagamentos;

implementation

{$R *.dfm}

procedure TfrmRelatorioPagamentos.btnConsultarClick(Sender: TObject);
begin
  if validarFormulario then
//  idStatus := QuotedStr(cbxStatus.Items[cbxStatus.ItemIndex]);

  begin
    carregarDadosEmpresa;
    if not (carregarDadosPagamentos) then
    begin
      btnExcel.Visible := false;
      btnImprimir.Enabled := false;
      ShowMessage('Consulta não retornou dados.');
      statusBar2.Panels[4].Text := 'Consulta retonou vazia.';
      exibirValoresPanel;
    end
    else
    begin
      exibirValoresPanel;
      btnImprimir.Enabled := True;
      btnExcel.Visible := True;
    end;
  end;
end;

procedure TfrmRelatorioPagamentos.btnExcelClick(Sender: TObject);
var
  linha, coluna: integer;
var
  planilha: variant;
var
  valorcampo: string;
begin
  //para excel foi informado que seriam todos os titulos. Considerando apenas periodo.

  if (dmContasPagar.obterTitulosExcel(TOrgAtual.getId, dtDataInicial.Date, dtDataFinal.Date)) then
  begin

    exibirRelatorioExcel(10); //10 inddica ser EXCEL
//   dmContasPagar.dtsTitulosExcel.DataSet.IsEmpty
  end
  else
  begin
    ShowMessage('Não é possível gerar exportação.');
  end;

end;

procedure TfrmRelatorioPagamentos.btnImprimirClick(Sender: TObject);
begin
  if validarFormulario then
  begin
    carregarDadosEmpresa;
    carregarDadosPagamentos;
    if (cbxTipoRelatorio.ItemIndex > (-1)) then
    begin
      if not (dmContasPagar.DSPreencheGridMain.DataSet.IsEmpty) then
      begin
        btnExcel.Visible := true; //libera exporta excel
        exibirRelatorio(cbxTipoRelatorio.ItemIndex);
      end
      else
      begin
        btnExcel.Visible := false;
        ShowMessage('Consulta não retornou dados');
      end;
    end;
  end;
end;

function TfrmRelatorioPagamentos.carregarCentrosCusto: Boolean;
begin
  dmContasPagar.qryCentroCusto.Close;
  dmContasPagar.qryCentroCusto.Open;
  Result := not dmContasPagar.qryCentroCusto.IsEmpty;
end;

procedure TfrmRelatorioPagamentos.carregarDadosEmpresa;
begin
  dmOrganizacao.qryDadosEmpresa.Close;
//  dmOrganizacao.qryDadosEmpresa.ParamByName('pIdOrganizacao').AsString := FsListaIdOrganizacoes[cbxOrganizacoes.ItemIndex];
  dmOrganizacao.qryDadosEmpresa.ParamByName('pIdOrganizacao').AsString := TOrgAtual.getId;
  dmOrganizacao.qryDadosEmpresa.Open;
end;

function TfrmRelatorioPagamentos.carregarDadosPagamentos: Boolean;
begin
  Result := false;

  if montarSQL then
  begin
    dmContasPagar.qryRelPagamentos.Close;
    dmContasPagar.qryRelPagamentos.Open;

    Result := not dmContasPagar.qryRelPagamentos.IsEmpty;
  end;

end;

procedure TfrmRelatorioPagamentos.exibirRelatorioExcel(tipo: Integer);
begin
// EXCEL TIPO 10

  frxReportExcel.Clear;
  if not (frxReportExcel.LoadFromFile(retornarCaminhoRelatorio(tipo))) then
  begin
    //Mensagem não encontrou o arquivo do relatorio. Fazer

  end
  else
  begin
    frxReportExcel.OldStyleProgress := True;
    frxReportExcel.ShowProgress := True;
    frxReportExcel.ShowReport;
  end;
end;

procedure TfrmRelatorioPagamentos.exibirValoresPanel;
begin
  if (cbxStatus.ItemIndex > (-1)) then
  begin

    statusBar2.Panels[0].Text := 'Total devido : R$ ' + CurrToStr(dmContasPagar.obterTotalPorStatus(TOrgAtual.getId, 'ABERTO', dtDataInicial.Date, dtDataFinal.Date));
    statusBar2.Panels[1].Text := 'Total pago   : R$ ' + CurrToStr(dmContasPagar.obterTotalPorStatus(TOrgAtual.getId, 'QUITADO', dtDataInicial.Date, dtDataFinal.Date));

  end;

end;

procedure TfrmRelatorioPagamentos.exibirRelatorio(tipo: Integer);
begin

  frxRelContasPagar.Clear;

  if not (frxRelContasPagar.LoadFromFile(retornarCaminhoRelatorio(tipo))) then
  begin
    //Mensagem não encontrou o arquivo do relatorio. Fazer

  end
  else
  begin
    inicializarVariaveisRelatorio;
    frxRelContasPagar.OldStyleProgress := True;
    frxRelContasPagar.ShowProgress := True;
    frxRelContasPagar.ShowReport;
  end;
end;

procedure TfrmRelatorioPagamentos.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  if Assigned(FsListaIdOrganizacoes) then
  begin
    FsListaIdOrganizacoes := nil;
  end;
  if Assigned(FsListaIdCentrosCusto) then
  begin
    FsListaIdCentrosCusto := nil;
  end;

  if Assigned(dmContasPagar) then
  begin
    FreeAndNil(dmContasPagar);
  end;

  Action := cafree;

end;

procedure TfrmRelatorioPagamentos.FormCreate(Sender: TObject);
begin
  btnExcel.Visible := False;
  btnImprimir.Enabled := false;
//LimpaTela(Self); ver funcao p limpar alguns componentes apenas

  //Obs.: Me lembre de falar do uses UBackup macoronada e da forma que a conexão está sendo feita
  //iniciar aplicação com uma tab específica

  if not (Assigned(dmContasPagar)) then
  begin
    dmContasPagar := TdmContasPagar.Create(Self);
  end;

  if dmOrganizacao.carregarOrganizacoes then
  begin
    preencherListaOrganizacoes;
    dtDataInicial.Date := now;
    dtDataFinal.Date := now;

  end;
  if carregarCentrosCusto then
  begin
    preencherListaCentrosCusto;
  end;
end;

procedure TfrmRelatorioPagamentos.freeAndNilDM(Sender: TObject);
begin
  if Assigned(dmOrganizacao) then
  begin
    FreeAndNil(dmOrganizacao);
  end;
end;

procedure TfrmRelatorioPagamentos.inicializarDM(Sender: TObject);
begin
  if not (Assigned(dmOrganizacao)) then
  begin
    dmOrganizacao := TdmOrganizacao.Create(self);
  end;

end;

procedure TfrmRelatorioPagamentos.inicializarVariaveisRelatorio;
begin
  with frxRelContasPagar.Variables do
  begin
    Variables['strRazaoSocial'] := QuotedStr(dmOrganizacao.qryDadosEmpresa.FieldByName('RAZAO_SOCIAL').AsString);
    Variables['strCNPJ'] := QuotedStr(dmOrganizacao.qryDadosEmpresa.FieldByName('CNPJ').AsString);
    Variables['strEndereco'] := QuotedStr(dmOrganizacao.qryDadosEmpresa.FieldByName('ENDERECO').AsString);
    Variables['strCEP'] := QuotedStr(dmOrganizacao.qryDadosEmpresa.FieldByName('CEP').AsString);
    Variables['strCidade'] := QuotedStr(dmOrganizacao.qryDadosEmpresa.FieldByName('CIDADE').AsString);
    Variables['strUF'] := QuotedStr(dmOrganizacao.qryDadosEmpresa.FieldByName('UF').AsString);
    Variables['strTipoStatus'] := QuotedStr(cbxStatus.Items[cbxStatus.ItemIndex]);

  end;
end;

function TfrmRelatorioPagamentos.montarSQL: Boolean;
var
  lsSQL: TStringList;
  x: string;
begin
  lsSQL := TStringList.Create;
  lsSQL.AddStrings(dmContasPagar.sqlScriptContainer.SQLScripts.FindScript('sqlRelPagamentos').SQL);
  lsSQL.Add('WHERE');
  lsSQL.Add(Format('  (TP.DATA_VENCIMENTO BETWEEN %s AND %s)', [QuotedStr(FormatDateTime('dd.mm.yyyy', dtDataInicial.Date)), QuotedStr(FormatDateTime('dd.mm.yyyy', dtDataFinal.Date))]));
  lsSQL.Add('AND');
//  lsSQL.Add(Format('  (TP.ID_ORGANIZACAO = %s)', [QuotedStr(FsListaIdOrganizacoes[cbxOrganizacoes.ItemIndex])]));

  lsSQL.Add(Format('  (TP.ID_ORGANIZACAO = %s)', [QuotedStr(TOrgAtual.getId)]));

  if (cbxCentrosCusto.ItemIndex > 0) then
  begin
    lsSQL.Add('AND');
    lsSQL.Add(Format('  (TPC.ID_CENTRO_CUSTO = %s)', [QuotedStr(FsListaIdCentrosCusto[cbxCentrosCusto.ItemIndex])]));
  end;
  if (cbxStatus.ItemIndex > 0) then
  begin
    lsSQL.Add('AND');
    lsSQL.Add(Format('  (TP.ID_TIPO_STATUS = %s)', [QuotedStr(cbxStatus.Items[cbxStatus.ItemIndex])]));
  end;
  lsSQL.Add('ORDER BY');
  lsSQL.Add('  ' + retornarCampoOrdenacao);

  dmContasPagar.qryRelPagamentos.SQL.Clear;
  dmContasPagar.qryRelPagamentos.SQL.Assign(lsSQL);
  x := dmContasPagar.qryRelPagamentos.SQL.Text;

  Result := (lsSQL.Count > 0);
  lsSql := nil;
end;

procedure TfrmRelatorioPagamentos.preencherListaCentrosCusto;
begin
  FsListaIdCentrosCusto := TStringList.Create;
  FsListaIdCentrosCusto.Clear;
  FsListaIdCentrosCusto.Add('Sem ID'); //Linha adicionada somente para combatibilizar com os itens do ComboBox cbxCentrosCusto
  cbxCentrosCusto.Clear;
  cbxCentrosCusto.Items.Add('TODOS');
  dmContasPagar.qryCentroCusto.First;
  while not dmContasPagar.qryCentroCusto.Eof do
  begin
    cbxCentrosCusto.Items.Add(dmContasPagar.qryCentroCusto.FieldByName('DESCRICAO').AsString);
    FsListaIdCentrosCusto.Add(dmContasPagar.qryCentroCusto.FieldByName('ID_CENTRO_CUSTO').AsString);
    dmContasPagar.qryCentroCusto.Next;
  end;
  dmContasPagar.qryCentroCusto.Close;
  cbxCentrosCusto.ItemIndex := 0;
end;

procedure TfrmRelatorioPagamentos.preencherListaOrganizacoes;
begin
  FsListaIdOrganizacoes := TStringList.Create;
  FsListaIdOrganizacoes.Clear;
 // cbxOrganizacoes.Clear;
  dmOrganizacao.qryOrganizacoes.First;
  while not dmOrganizacao.qryOrganizacoes.Eof do
  begin
   // cbxOrganizacoes.Items.Add(dmOrganizacao.qryOrganizacoes.FieldByName('NOME').AsString);
    FsListaIdOrganizacoes.Add(dmOrganizacao.qryOrganizacoes.FieldByName('ID_ORGANIZACAO').AsString);
    dmOrganizacao.qryOrganizacoes.Next;
  end;
  dmOrganizacao.qryOrganizacoes.Close;
  //cbxOrganizacoes.ItemIndex := 0;
end;

function TfrmRelatorioPagamentos.retornarCaminhoRelatorio(tipo: Integer): string;
begin

//teste
 //Result :=    ExtractFilePath(Application.ExeName) + 'relContasPagarPorFiltroExcel.fr3';

  case tipo of
    0:
      Result := ExtractFilePath(Application.ExeName) + 'relContasPagarPorFiltro.fr3';
    1:
      Result := ExtractFilePath(Application.ExeName) + 'relContasPagarPorFiltroAnalitico.fr3';
    10:
      Result := ExtractFilePath(Application.ExeName) + 'relContasPagarPorFiltroExcel.fr3';
  end;

end;

function TfrmRelatorioPagamentos.retornarCampoOrdenacao: string;
begin
  case cbxOrdem.ItemIndex of
    0:
      Result := 'TP.VALOR_NOMINAL';
    1:
      Result := 'C.NOME';
    2:
      Result := 'CC.DESCRICAO';
    3:
      Result := 'TP.DATA_PAGAMENTO';
    4:
      Result := 'TP.DATA_VENCIMENTO';
    5:
      Result := 'H.DESCRICAO';
    6:
      Result := 'T.DESCRICAO';
  end;
end;

function TfrmRelatorioPagamentos.validarFormulario: boolean;
begin
  Result := true;
end;

end.


