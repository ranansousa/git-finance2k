unit uDMTransfBancoCaixa;

interface

uses
  System.SysUtils, udmConexao, uUtil, System.Classes, FireDAC.Stan.Intf, System.DateUtils,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS,uCheque,
  FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt,
  Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, frxClass, frxDBSet;

type
  TdmTransfBancoCaixa = class(TDataModule)
    qryExisteIdentificacao: TFDQuery;
    qryObterGUID: TFDQuery;
    qryObterTOB: TFDQuery;
    qryChequePorID: TFDQuery;
    qryObterCBD: TFDQuery;
    qryObterTC: TFDQuery;
    qryDeletaCBD: TFDQuery;
    qryDeletaTC: TFDQuery;
    qryUpdateCheque: TFDQuery;
    frxRelTRFBCOCAIXA: TfrxReport;
    frxCBD: TfrxDBDataset;
    frxTC: TfrxDBDataset;
    frxCheque: TfrxDBDataset;
    procedure DataModuleCreate(Sender: TObject);
  private
    { Private declarations }
      pIDOrganizacao :string;

  public
    { Public declarations }
    function obterNewID: string;
    function obterCheque(pIdOrganizacao, pContaBancaria, pIdCheque :string) :TChequeModel;
    function verificarIdentificador(pIdOrganizacao, pValor: string): Integer;
    function obterIdentificador(pIdOrganizacao: string): string;
    function obterTipoOperacaoBancaria(pIdOrganizacao, pIdTOB: string): TFDQuery;
    function transferenciaBancoCaixa ( pIdOrganizacao,pContaBancaria, pTOB,pResponsavel,pIDCheque, pDescricao, pIdentificacao :string; pValor :Currency; pDataMovimento :TDate) : Boolean;

    //parte do estorno
    function obterCBD(pIdOrganizacao :string; pDataInicial, pDataFinal :TDate):Boolean;
    function obterTC(pIdOrganizacao, pIdCBD :string):Boolean;
    function deletarCBD(pIdOrganizacao, pIdCBD :string):Boolean;
    function deletarTC(pIdOrganizacao, pIdCbd, pIdTC :string) :Boolean;
    function alteraCheque(pIdOrganizacao, pContaBancaria, pIdCheque :string) :Boolean;






  end;

var
  dmTransfBancoCaixa: TdmTransfBancoCaixa;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

{$R *.dfm}

function TdmTransfBancoCaixa.alteraCheque(pIdOrganizacao, pContaBancaria,
  pIdCheque: string): Boolean;
begin

   dmConexao.conectarBanco;

   try

    qryUpdateCheque.Close;
    qryUpdateCheque.Connection := dmConexao.conn;
    qryUpdateCheque.ParamByName('PIDCONTA').AsString := pContaBancaria;
    qryUpdateCheque.ParamByName('PIDORGANIZACAO').AsString := pIDOrganizacao;
    qryUpdateCheque.ParamByName('PIDCHEQUE').AsString := pIdCheque;
    qryUpdateCheque.ExecSQL;


     dmConexao.conn.CommitRetaining;

   except
        dmConexao.conn.RollbackRetaining;
        Result :=False;
   raise Exception.Create('Erro alterar dados do cheque ');
   end;
   Result :=True;
end;

procedure TdmTransfBancoCaixa.DataModuleCreate(Sender: TObject);
begin
 dmConexao.conectarBanco;

 pIDOrganizacao := uUtil.TOrgAtual.getId;

end;



function TdmTransfBancoCaixa.obterNewID: string;
var id:string;
begin
//fornece um novo id.
//o banco precisa ter instalado a UDF createguid
  id := '0';

  qryObterGUID.Close;
  qryObterGUID.Connection := dmConexao.Conn;
  qryObterGUID.Open;


    if  not qryObterGUID.IsEmpty then
      begin
       id := qryObterGUID.FieldByName('NEWID').AsString;
     end;

 Result := id;
end;

function TdmTransfBancoCaixa.obterTC(pIdOrganizacao, pIdCBD: string): Boolean;
begin

  dmConexao.conectarBanco;
  try
    qryObterTC.Close;
    qryObterTC.Connection := dmConexao.conn;
    qryObterTC.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryObterTC.ParamByName('PIDCBD').AsString := pIdCBD;
    qryObterTC.Open;
  except
    raise Exception.Create('Erro ao obter TC');

  end;

  Result := not qryObterTC.IsEmpty;

end;

function TdmTransfBancoCaixa.obterTipoOperacaoBancaria(pIdOrganizacao, pIdTOB: string): TFDQuery;
begin
dmConexao.conectarBanco;
 try

    qryObterTOB.Close;
    qryObterTOB.Connection := dmConexao.Conn;
    qryObterTOB.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryObterTOB.ParamByName('PIDTOB').AsString := pIdTOB;
    qryObterTOB.Open;


 except
 raise Exception.Create('Erro ao obter TOB');

 end;


 Result := qryObterTOB;


end;

function TdmTransfBancoCaixa.transferenciaBancoCaixa(pIdOrganizacao,
  pContaBancaria, pTOB, pResponsavel, pIDCheque, pDescricao,
  pIdentificacao: string; pValor: Currency; pDataMovimento: TDate): Boolean;
  var
pIDHistorico, pOBS, IDCBD, IDTC, idUsuario, tipoLanc, tipoTOB, cmdCheque, cmdCBD, cmdTC :string;
pDataRegistro :TDate;
qryCBD, qryTC,qryUpdateCheque :TFDQuery;
chequeLiberado :Boolean;
 cheque :TChequeModel;

begin
  try
   chequeLiberado := False;

   IDCBD := obterNewID;
   idUsuario :=uutil.TUserAtual.getUserId;
   tipoLanc := 'D';

   pDataRegistro  := StrToDate(FormatDateTime('DD/MM/YYYY',now ));
   pOBS := ' TRANSF DO BCO P/ TES. ';


   //se for cheque precisa update no cheque

      if not (uUtil.Empty(pIDCheque)) then
      begin
        cheque := TChequeModel.Create;
        cheque := obterCheque(pIdOrganizacao, pContaBancaria, pIDCheque);
          if cheque.FIdCheque.Equals(pIDCheque) then
          begin
            if not cheque.FIdTipoStatus.Equals('COMPENSADO') then
            begin
              chequeLiberado := True;
            end;
          end;


            if chequeLiberado then
            begin

              cmdCheque := ' UPDATE CONTA_BANCARIA_CHEQUE ' + ' SET ID_TIPO_STATUS = ''COMPENSADO'', ' + ' VALOR = :PVALOR , ' +
                           ' DATA_EMISSAO = :PDTEMISSAO , ' + ' DATA_COMPENSACAO = :PDTCOMPENSADO , ' +
                           ' DATA_PREVISAO_COMPENSACAO = :PDTPREVISAO , ' + ' OBSERVACAO = :POBS ,' + ' PORTADOR = :PPORTADOR ' +
                           ' WHERE (ID_CONTA_BANCARIA_CHEQUE = :PIDCHEQUE) ' +
                           ' AND (ID_ORGANIZACAO = :PIDORGANIZACAO) ';
                try
                qryUpdateCheque := TFDQuery.Create(Self);
                qryUpdateCheque.Close;
                qryUpdateCheque.Connection := dmConexao.conn;
                qryUpdateCheque.SQL.Clear;
                qryUpdateCheque.SQL.Add(cmdCheque);

                qryUpdateCheque.ParamByName('PIDCHEQUE').AsString := pIDCheque;
                qryUpdateCheque.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
                qryUpdateCheque.ParamByName('PVALOR').AsCurrency := pValor;

                qryUpdateCheque.ParamByName('POBS').AsString := pOBS;
                qryUpdateCheque.ParamByName('PPORTADOR').AsString := uutil.TOrgAtual.getRazaoSocial;
                qryUpdateCheque.ParamByName('PDTEMISSAO').AsDate := pDataMovimento;
                qryUpdateCheque.ParamByName('PDTCOMPENSADO').AsDate := pDataMovimento;
                qryUpdateCheque.ParamByName('PDTPREVISAO').AsDate := pDataMovimento;

                qryUpdateCheque.ExecSQL;
                 dmConexao.conn.CommitRetaining;

                except
                 dmConexao.conn.RollbackRetaining;
                 Result := False;
                raise Exception.Create('Erro ao alterar dados do cheque ' + cheque.FNumeroCheque );
                end;
            end; //fim do begin do cheque
      end; // fim da parte do cheque

   //insere CBD

    qryCBD := TFDQuery.Create(Self); //insere na conta bancaria debito

    cmdCBD := ' INSERT INTO CONTA_BANCARIA_DEBITO (ID_CONTA_BANCARIA_DEBITO, ID_ORGANIZACAO, ID_CONTA_BANCARIA,  '+
              ' ID_TIPO_OPERACAO_BANCARIA, ID_RESPONSAVEL, ID_CONTA_BANCARIA_CHEQUE, ID_USUARIO, '+
              ' TIPO_LANCAMENTO, OBSERVACAO, DESCRICAO, VALOR, DATA_REGISTRO, DATA_MOVIMENTO, IDENTIFICACAO ) ' +
              ' VALUES (:PID, :PIDORGANIZACAO, :PIDCONTA, :PIDTOB, :PIDRESPONSAVEL, :PIDCHEQUE, :PIDUSUARIO,  ' +
              ' :PTIPOLANC, :POBS, :PDESCRICAO, :PVALOR, :PDTREGISTRO, :PDTMOVIMENTO, :PIDENTIFICACAO );' ;

    try
      qryCBD.Close;
      qryCBD.Connection := dmConexao.conn;
      qryCBD.SQL.Clear;
      qryCBD.SQL.Add(cmdCBD);
      qryCBD.ParamByName('PVALOR').AsCurrency := pValor;
      qryCBD.ParamByName('PID').AsString := IDCBD;
      qryCBD.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
      qryCBD.ParamByName('PIDCONTA').AsString := pContaBancaria;
      qryCBD.ParamByName('PIDTOB').AsString := pTOB;
      qryCBD.ParamByName('PIDRESPONSAVEL').AsString := pResponsavel;
      qryCBD.ParamByName('PDESCRICAO').AsString := pDescricao ;
      if not (uUtil.Empty(pIDCheque)) then  begin
        qryCBD.ParamByName('PIDCHEQUE').AsString := pIDCheque;
        qryCBD.ParamByName('PDESCRICAO').AsString := pDescricao + ' CH ' + cheque.FNumeroCheque;
      end;
      qryCBD.ParamByName('PIDUSUARIO').AsString := idUsuario;
      qryCBD.ParamByName('PTIPOLANC').AsString := tipoLanc;
      qryCBD.ParamByName('POBS').AsString := pOBS;
      qryCBD.ParamByName('PIDENTIFICACAO').AsString := pIdentificacao;
      qryCBD.ParamByName('PDTREGISTRO').AsDate := pDataRegistro;
      qryCBD.ParamByName('PDTMOVIMENTO').AsDate := pDataMovimento;

      qryCBD.ExecSQL;
      dmConexao.conn.CommitRetaining;
    except
      dmConexao.conn.RollbackRetaining;
      Result := False;
      raise Exception.Create('Erro ao debitar na conta bancária');
    end;

    try
      IDTC := obterNewID; //para a TC
      pIDHistorico := 'TRANSFERE BANCO/TESOURARIA';

      cmdTC := ' INSERT INTO TESOURARIA_CREDITO (ID_TESOURARIA_CREDITO, ID_ORGANIZACAO, ID_HISTORICO, ID_RESPONSAVEL, ' +
               ' DATA_REGISTRO, DATA_CONTABIL, DATA_MOVIMENTO, VALOR_NOMINAL, OBSERVACAO, NUMERO_DOCUMENTO, DESCRICAO, ' +
               ' TIPO_LANCAMENTO, ID_USUARIO, ID_CONTA_BANCARIA_DEBITO, ID_SACADO) ' +
               ' VALUES (:PIDTC, :PIDORGANIZACAO, :PIDHISTORICO, :PIDRESPONSAVEL, :PDTREGISTRO, :PDTCONTABIL, :PDTMOVIMENTO, '+
               ' :PVALOR, :POBS, :PNUMDOC, :PDESCRICAO, ''C'', :PIDUSUARIO, :PIDCBD, :PIDSACADO  )' ;


      qryTC := TFDQuery.Create(Self); // insere na tesouraria credito
      qryTC.Close;
      qryTC.Connection := dmConexao.conn;
      qryTC.SQL.Clear;
      qryTC.SQL.Add(cmdTC);
      qryTC.ParamByName('PVALOR').AsCurrency := pValor;
      qryTC.ParamByName('PIDTC').AsString := IDTC;
      qryTC.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
      qryTC.ParamByName('PIDCBD').AsString := IDCBD;
      qryTC.ParamByName('PIDUSUARIO').AsString := uUtil.TUserAtual.getUserId;
      qryTC.ParamByName('PIDSACADO').AsString := pIdOrganizacao;

      qryTC.ParamByName('PIDHISTORICO').AsString := pIDHistorico;
      qryTC.ParamByName('PIDRESPONSAVEL').AsString := pResponsavel;
      qryTC.ParamByName('PDTREGISTRO').AsDate := pDataRegistro;
      qryTC.ParamByName('PDTMOVIMENTO').AsDate := pDataMovimento;
      qryTC.ParamByName('PDTCONTABIL').AsDate := pDataMovimento;
      qryTC.ParamByName('POBS').AsString := pOBS;
      qryTC.ParamByName('PDESCRICAO').AsString := pDescricao ;

      if not (uUtil.Empty(pIDCheque)) then  begin
       qryTC.ParamByName('PDESCRICAO').AsString := pDescricao + ' CH ' + cheque.FNumeroCheque;
      end;

      qryTC.ParamByName('PNUMDOC').AsString := pIdentificacao;

      qryTC.ExecSQL;
      dmConexao.conn.CommitRetaining;

    except
      dmConexao.conn.RollbackRetaining;
      Result := False;
      raise Exception.Create('Erro ao creditar na tesouraria.');
    end;


  except
  dmConexao.conn.RollbackRetaining;
  Result :=False;
  raise Exception.Create(' Não foi possível realizar a transferência.');
  end;

    Result :=True;

end;

function TdmTransfBancoCaixa.verificarIdentificador(pIdOrganizacao, pValor: string): Integer;

var
qtd :Integer;
begin
qtd :=0;
 dmConexao.conectarBanco;


  try
    qryExisteIdentificacao.Close;
    qryExisteIdentificacao.Connection := dmConexao.Conn;
    qryExisteIdentificacao.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryExisteIdentificacao.ParamByName('PIDENTIFICACAO').AsString := pValor;
    qryExisteIdentificacao.Open;

     qtd := qryExisteIdentificacao.FieldByName('QTD').AsInteger;


  except
   raise Exception.Create('Erro ao verificar o identificador ' + pValor);

  end;

   Result := qtd;

end;


function TdmTransfBancoCaixa.deletarCBD(pIdOrganizacao,
  pIdCBD: string): Boolean;
begin
  dmConexao.conectarBanco;
  try

    qryDeletaCBD.Close;
    qryDeletaCBD.Connection := dmConexao.conn;
    qryDeletaCBD.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryDeletaCBD.ParamByName('PIDCBD').AsString := pIdCBD;
    qryDeletaCBD.ExecSQL;

    dmConexao.conn.CommitRetaining;

  except
    dmConexao.conn.RollbackRetaining;
    Result := False;
    raise Exception.Create('Erro ao deletar CBD');

  end;
  Result := True;
end;




function TdmTransfBancoCaixa.deletarTC(pIdOrganizacao, pIdCbd,
  pIdTC: string): Boolean;
begin
 dmConexao.conectarBanco;
  try

    qryDeletaTC.Close;
    qryDeletaTC.Connection := dmConexao.conn;
    qryDeletaTC.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryDeletaTC.ParamByName('PIDCBD').AsString := pIdCBD;
    qryDeletaTC.ParamByName('PIDTC').AsString := pIdTC;

    qryDeletaTC.ExecSQL;

    dmConexao.conn.CommitRetaining;

  except
    dmConexao.conn.RollbackRetaining;
    Result := False;
    raise Exception.Create('Erro ao deletar CBD');

  end;
  Result := True;


end;

function TdmTransfBancoCaixa.obterCBD(pIdOrganizacao: string; pDataInicial,
  pDataFinal: TDate): Boolean;
begin
   dmConexao.conectarBanco;
try

  qryObterCBD.Close;
  qryObterCBD.Connection := dmConexao.conn;
  qryObterCBD.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
  qryObterCBD.ParamByName('PDTINICIAL').AsDate := pDataInicial;
  qryObterCBD.ParamByName('PDTFINAL').AsDate := pDataFinal;
  qryObterCBD.Open;
except
raise Exception.Create('Erro ao obter CBD');

end;


  Result := not qryObterCBD.IsEmpty;
end;

function TdmTransfBancoCaixa.obterCheque(pIdOrganizacao, pContaBancaria, pIdCheque: string): TChequeModel;
var
cheque : TChequeModel;

begin
   cheque :=TChequeModel.Create;
   dmConexao.conectarBanco;

   try

    qryChequePorID.Close;
    qryChequePorID.Connection := dmConexao.conn;
    qryChequePorID.ParamByName('PIDCONTA').AsString := pContaBancaria;
    qryChequePorID.ParamByName('PIDORGANIZACAO').AsString := pIDOrganizacao;
    qryChequePorID.ParamByName('PIDCHEQUE').AsString := pIdCheque;

    qryChequePorID.Open;

     if not  qryChequePorID.IsEmpty then begin
      cheque.SetIdCheque(qryChequePorID.FieldByName('id_conta_bancaria_cheque').AsString);
      cheque.SetIdOrganizacao(qryChequePorID.FieldByName('id_organizacao').AsString);
      cheque.SetIdContaBancaria(qryChequePorID.FieldByName('id_conta_bancaria').AsString);
      cheque.SetIdFuncionario(qryChequePorID.FieldByName('id_funcionario').AsString);
      cheque.SetIdTipoStatus(qryChequePorID.FieldByName('id_tipo_status').AsString);
      cheque.SetNumeroCheque(qryChequePorID.FieldByName('numero_cheque').AsString);
      cheque.SetObservacao(qryChequePorID.FieldByName('observacao').AsString);

      cheque.SetPortador(qryChequePorID.FieldByName('portador').AsString);
      cheque.SetIdUsuario(qryChequePorID.FieldByName('id_usuario').AsString);
      cheque.SetDataCompensacao(qryChequePorID.FieldByName('data_previsao_compensacao').AsDateTime);
      cheque.SetDataEstorno(qryChequePorID.FieldByName('data_estorno').AsDateTime);
      cheque.SetDataRegistro(qryChequePorID.FieldByName('data_registro').AsDateTime);
      cheque.SetDataEmissao(qryChequePorID.FieldByName('data_emissao').AsDateTime);
      cheque.SetDataCompensacao(qryChequePorID.FieldByName('data_compensacao').AsDateTime);
      cheque.SetValor(qryChequePorID.FieldByName('valor').AsCurrency);
      cheque.SetQtdImpressao(qryChequePorID.FieldByName('qtd_impressao').AsInteger);

     end;


   except
   raise Exception.Create('Erro ao obter cheque por ID');

   end;

   Result := cheque;
end;






function TdmTransfBancoCaixa.obterIdentificador(pIdOrganizacao: string): string;
var
_strIdentificador :string;
pDia, pMes, pAno :string;
 incAux,qtdExist :Integer;

begin
_strIdentificador :='';
  incAux :=1;
  pDia := FormatDateTime('DD',Now);
  pMes := FormatDateTime('MM',Now);
  pAno := FormatDateTime('YYYY',Now);
  _strIdentificador := pAno + pMes+ pDia + IntToStr(incAux)   ; //2019 11 19 1

  try

    qtdExist := verificarIdentificador(pIdOrganizacao, _strIdentificador);

    while ( qtdExist > 0) do begin

      Inc(incAux);
     _strIdentificador :=  pAno + pMes+ pDia + IntToStr(incAux);
      qtdExist := verificarIdentificador(pIdOrganizacao, _strIdentificador);

    end;


  except

   raise Exception.Create('Erro ao tentar gerar um identificador..');

  end;


 Result := _strIdentificador;
end;





end.
