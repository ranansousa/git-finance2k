unit uDMExportaFinance;

interface

uses
  System.SysUtils, uDMMegaContabil, System.Classes, UMostraErros, FireDAC.Stan.Intf,
  FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB, udmConexao, FireDAC.Comp.DataSet, FireDAC.Comp.Client,
  FireDAC.UI.Intf, FireDAC.Comp.ScriptCommands, FireDAC.Stan.Util, FireDAC.Comp.Script, uLancamentoCreditoModel,
  uLancamentoDebitoModel, uUtil, uListaLancamentosCredito, uListaLancamentosDebito, uListaLancamentos;

type
  TdmExportaFinance = class(TDataModule)
    qryGravarLoteContabil: TFDQuery;
    qryObterCentroCustoPorTitulo2: TFDQuery;
    qryObterCBTPERIODO: TFDQuery;
    qryObterCBCPERIODO: TFDQuery;
    qryObterCBDPERIODO: TFDQuery;
    qryObterTDPERIODO: TFDQuery;
    qryObterTCPERIODO: TFDQuery;
    qryObterPendentes: TFDQuery;
    qryInserePendente: TFDQuery;
    qryLimparPendentes: TFDQuery;
    qryObterValorDebitoGeneric: TFDQuery;
    qryUpdateGeneric: TFDQuery;
    qryHstSemCC: TFDQuery;
    qryBancoCaixa: TFDQuery;
    qryCaixaBanco: TFDQuery;
    qryTPPROVBASE: TFDQuery;
    qryTPPROVDB: TFDQuery;
    qryTPPROVCR: TFDQuery;
    qryObterValorTitulo: TFDQuery;
    qryTPB: TFDQuery;
    qryTRBAcrescimos: TFDQuery;
    qryTPBAcrescimos: TFDQuery;
    qryTPBDeducao: TFDQuery;
    qryTPBCaixa: TFDQuery;
    qryTPBCheque: TFDQuery;
    qryTPBInternet: TFDQuery;
    qryObterTodosLoteContabil: TFDQuery;
    qryDeletaLoteContabil: TFDQuery;
    qrytpprovbase_1: TFDQuery;
    qryTPBHistorico: TFDQuery;
    qryTRB: TFDQuery;
    qryTRBDeducao: TFDQuery;
    qryTRBHistorico: TFDQuery;
    qryTRBCaixa: TFDQuery;
    qryTRBCheque: TFDQuery;
    qryTRBInternet: TFDQuery;
    qryTR: TFDQuery;
    qryTRCR: TFDQuery;
    qryTRDB: TFDQuery;
    qryExistCODREDUZ: TFDQuery;
    procedure DataModuleCreate(Sender: TObject);
  private
    { Private declarations }
    FsListaDebito: TListaLancamentoDebito;
    FsListaCredito: TListaLancamentoCredito;
    FsListaLancamentos: TListaLancamentos;
    procedure inicializarDM(Sender: TObject);
    procedure freeAndNilDM(Sender: TObject);
    function getListaForMega: TListaLancamentos;
    function obterTPProvCR(pIdOrganizacao, pRegistroProvisao: string): Boolean;
    function obterTPProvDB(pIdOrganizacao, pRegistroProvisao: string): Boolean;
    function obterTPBAC(pIdOrganizacao, pIdTPB: String): Boolean; //obtem acrescimos
    function obterTPBDE(pIdOrganizacao, pIdTPB : String): Boolean;
    function obterTPBCAIXA(pIdOrganizacao, pIdTPB: String): Boolean;
    function obterTPBCHEQUE(pIdOrganizacao, pIdTPB: String): Boolean;
    function obterTPBINTERNET(pIdOrganizacao, pIdTPB: String): Boolean;
    function obterTPBHistorico(pIdorganizacao,
      tituloPagarQuitado: string): Boolean;


    //detalhes contas a receber
    function obterTRBHistorico(pIdorganizacao,tituloReceberQuitado: string): Boolean;
    function obterTRBAC(pIdOrganizacao, pIdTRB: String): Boolean; //obtem acrescimos
    function obterTRBDE(pIdOrganizacao, pIdTRB : String): Boolean;
    function obterTRBBAC(pIdOrganizacao, pIdTRB: String): Boolean;
    function obterTRBCAIXA(pIdOrganizacao, pIdTRB: String): Boolean;
    function obterTRBCHEQUE(pIdOrganizacao, pIdTRB: String): Boolean;
    function obterTRBINTERNET(pIdOrganizacao, pIdTR: String): Boolean;
    function convertTRPROVToLancamentoMega(pTipoTitulo, pIdOrganizacao,
      pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery;
      var loMostraErros: TFMostraErros): TListaLancamentos;


      //obtem deducoes

    {  FormatDateTime('mm/dd/yyyy', pDataInicial);}


  public
    { Public declarations }
//  function obterTPProvisionados(pIdOrganizacao,pIdStatus :String ; pDataInicial, pDataFinal:TDate;pProvisao :Integer): Boolean;
    function obterListaHistoricoSemContaContabil(pIdOrganizacao: String): Boolean;

    function obterCBCPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
    function obterCBDPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
    function obterTCPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
    function obterTDPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;

    function inserePendente(pIdOrganizacao, pTIPO, pIDENTIFICACAO, pPENDENCIA: string; pVALOR: Currency): Boolean;

    function limpaPendentes(pIdOrganizacao: string): Boolean;
    function obterPendentesPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): Boolean;
    procedure validarLancamentos(pIdOrganizacao: string; plista: TListaLancamentos; pCodeEmpresa: Integer);
    function obterValorDebitoGeneric(pIdOrganizacao,pTable,pCampoSum, pCampoData :string; pDataInicial, pDataFinal: TDate ):Currency;
    function obterValorDebitoGenericTOB(pIdOrganizacao, pTable, pCampo, pTipo: string; pDataInicial, pDataFinal: TDate): Currency;
    function updateIDLoteContabilGeneric(pTable,pIdOrganizacao,pIdRegistro, pIdLote, registroProvisao :string): Boolean;
    function obterValorDebitoTitulo(pIdOrganizacao, pTable, pCampoSum, pCampoData: string; pDataInicial, pDataFinal: TDate; isProvisao :Integer): Currency;
    function obterValorDebitoTituloProvisao(pIdOrganizacao, pTable, pCampoSum, pCampoData: string; pDataInicial, pDataFinal: TDate; isProvisao :Integer): Currency;

    //exportacao para o mega
    function gravarLoteContabil(pIdLote, pIdOrganizacao, pLote, pDataInicial, pDataFinal: string; pLista :TListaLancamentos; pTable :string; qtdRegistros :Integer; valorDebito, valorCredito : Currency): Boolean;
    function convertTFDQueryToLancamentoMega(pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery): TListaLancamentos;
    function obterCBTPorPeriodo(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
    function obterTBTPorPeriodo(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
    function obterCaixaBancoPorPeriodo(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;



    // contas a receber
    function obterValorDebitoTRB(pIdOrganizacao, pTable, pCampoSum,pCampoData: string; pDataInicial, pDataFinal: TDate; isProvisao :Integer): Currency;
    function convertTRBToMega(pTipoTitulo, pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery;var loMostraErros: TFMostraErros): TListaLancamentos;
    function obterTRB(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
    function obterTitulosReceberProvisionados(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;

     //contas a pagar
    function obterTPPROVBase(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
    function obterTPB_PROV(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
    function obterValorDebitoTPB(pIdOrganizacao, pTable, pCampoSum,pCampoData: string; pDataInicial, pDataFinal: TDate; isProvisao :Integer): Currency;
    function convertTPROVToLancamentoMega(pTipoTitulo, pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery; var loMostraErros: TFMostraErros): TListaLancamentos;
    function convertTPB_PROVToLancamentoMega(pTipoTitulo,pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery; var loMostraErros: TFMostraErros): TListaLancamentos;
    function convertoTPB_PROVToLancamentoDebito(pCodEmpresa, pLote, pAno, pCodReduzDeb,pCodHist: Integer; pHistorico, pComple, pDgCodReduzDeb, pContaDeb, pDgDeb,  pTipo,pIdFinance, pIdentFnc: string; pValor: Currency; pData: TDateTime) : TLancamentoDebitoModel;
    function convertoTPB_PROVToLancamentoCredito(pCodEmpresa, pLote, pAno, pCodReduzCre,pCodHist: Integer; pHistorico, pComple, pDgCodReduzCre, pContaCre, pDgCre,  pTipo,pIdFinance, pIdentFnc: string; pValor: Currency; pData: TDateTime) : TLancamentoCreditoModel;

//LOTE CONTABIL
    function obterTodosLoteContabil(pIdOrganizacao : string; pDataInicial, pDataFinal: TDate) :boolean;
    function deletaLoteContabil(pIdOrganizacao, pIdLote : string ) :boolean;
    function preencheComboLoteContabil(pIdOrganizacao, pAno : string ) :boolean;


 //genericos

      function obterContaMegaPorCodigo(pCodEmpresa,pCODREDUZ :Integer) : Boolean;

      function convertoTITULOinLancamentoDebito(pCodEmpresa, pLote, pAno,
      pCodReduzDeb, pCodHist: Integer; pHistorico, pComple, pDgCodReduzDeb,
      pContaDeb, pDgDeb, pTipo, pIdFinance, pIdentFnc: string; pValor: Currency;
      pData: TDateTime): TLancamentoDebitoModel;

      function convertoTITULOinLancamentoCredito(pCodEmpresa, pLote, pAno,
      pCodReduzCre, pCodHist: Integer; pHistorico, pComple, pDgCodReduzCre,
      pContaCre, pDgCre, pTipo, pIdFinance, pIdentFnc: string; pValor: Currency;
      pData: TDateTime): TLancamentoCreditoModel;



  //function listaExportacaoCBC(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
 //function listaExportacaoCBD(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;

  end;

var
  dmExportaFinance: TdmExportaFinance;

implementation

{%CLASSGROUP 'Vcl.Controls.TControl'}

procedure TdmExportaFinance.DataModuleCreate(Sender: TObject);
begin
inicializarDM(Self);
end;

function TdmExportaFinance.deletaLoteContabil(pIdOrganizacao,
  pIdLote: string): boolean;
begin
//coloca o lote como excluido

  try
    qryDeletaLoteContabil.Close;
    qryDeletaLoteContabil.Connection := dmConexao.Conn;
    qryDeletaLoteContabil.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryDeletaLoteContabil.ParamByName('PIDLOTE').AsString := pIdLote;

    qryDeletaLoteContabil.ExecSQL;
    dmConexao.Conn.CommitRetaining;
  except
  dmConexao.Conn.RollbackRetaining;
    raise(Exception).Create('Problemas ao deletar lote contabil ');

  end;

end;

procedure TdmExportaFinance.freeAndNilDM(Sender: TObject);
begin
  if not (Assigned(dmMegaContabil)) then
  begin
    FreeAndNil(dmMegaContabil);
  end;
end;

function TdmExportaFinance.getListaForMega(): TListaLancamentos;
      //pegar todas as listas criadas e cria uma unica
      // OU seria melhor exportar por tipo de lancamento?
begin

  Result := FsListaLancamentos;
end;


{$R *.dfm}

function TdmExportaFinance.obterCBTPorPeriodo(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
begin
  try

    FsListaLancamentos := TListaLancamentos.Create;

        qryObterCBTPERIODO.Connection := dmConexao.Conn;
        qryObterCBTPERIODO.Close;
        qryObterCBTPERIODO.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryObterCBTPERIODO.ParamByName('DTDATAINICIAL').AsString := FormatDateTime('mm/dd/yyyy', pDataInicial);
        qryObterCBTPERIODO.ParamByName('DTDATAFINAL').AsString := FormatDateTime('mm/dd/yyyy', pDataFinal);
        qryObterCBTPERIODO.Open;

    //convertendo para lista
    if not qryObterCBTPERIODO.IsEmpty then
    begin
      try
        FsListaLancamentos := convertTFDQueryToLancamentoMega(pIdOrganizacao, pAno, pCodEmpresa, pLote, qryObterCBTPERIODO);

      except  
        raise(Exception).Create('Problemas ao tentar CONVERTER lançamentos CBT');   
      end;


    end;


  except

    raise(Exception).Create('Problemas ao tentar exportar lançamentos CBT');

  end;

  Result := FsListaLancamentos;
end;

function TdmExportaFinance.obterContaMegaPorCodigo(pCodEmpresa,
  pCODREDUZ: Integer): Boolean;
begin
  dmConexao.conectarMega;
  //verificar no MEGA se existe a conta com base no codido reduzido
    try
        qryExistCODREDUZ.Connection := dmConexao.ConnMega;
        qryExistCODREDUZ.Close;
        qryExistCODREDUZ.ParamByName('PIDEMPRESA').AsInteger := pCodEmpresa;
        qryExistCODREDUZ.ParamByName('PCODREDUZ').AsInteger := pCODREDUZ;
        qryExistCODREDUZ.Open;

       Result := not qryExistCODREDUZ.IsEmpty;

   except

    raise(Exception).Create('Problemas ao tentar obter a conta no MEGA.. ');

  end;

end;

function TdmExportaFinance.obterPendentesPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): Boolean;
begin
   try
        qryObterPendentes.Connection := dmConexao.Conn;
        qryObterPendentes.Close;
        qryObterPendentes.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryObterPendentes.Open;
   except

    raise(Exception).Create('Problemas ao tentar obter pendentes ...');

  end;

  Result := not qryObterPendentes.IsEmpty;

end;

function TdmExportaFinance.obterCBCPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
begin
  FsListaLancamentos := TListaLancamentos.Create;

  qryObterCBCPERIODO.Connection := dmConexao.Conn;
  qryObterCBCPERIODO.Close;
  qryObterCBCPERIODO.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
  qryObterCBCPERIODO.ParamByName('DTDATAINICIAL').AsString := FormatDateTime('mm/dd/yyyy', pDataInicial);
  qryObterCBCPERIODO.ParamByName('DTDATAFINAL').AsString := FormatDateTime('mm/dd/yyyy', pDataFinal);

  qryObterCBCPERIODO.Open;

//  Result := not qryObterCBCPERIODO.IsEmpty;

  Result := FsListaLancamentos;
end;

function TdmExportaFinance.obterCBDPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
begin
  FsListaLancamentos := TListaLancamentos.Create;
  if not qryObterCBDPERIODO.Connection.Connected then
  begin
    qryObterCBDPERIODO.Connection := dmConexao.Conn;
  end;

  qryObterCBDPERIODO.Close;
  qryObterCBDPERIODO.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
  qryObterCBDPERIODO.ParamByName('DTDATAINICIAL').AsString := FormatDateTime('mm/dd/yyyy', pDataInicial);
  qryObterCBDPERIODO.ParamByName('DTDATAFINAL').AsString := FormatDateTime('mm/dd/yyyy', pDataFinal);

  qryObterCBDPERIODO.Open;

  //Result := not qryObterCBDPERIODO.IsEmpty;
  Result := FsListaLancamentos;
end;

function TdmExportaFinance.obterTDPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
begin
  FsListaLancamentos := TListaLancamentos.Create;

        qryObterTDPERIODO.Connection := dmConexao.Conn;
        qryObterTDPERIODO.Close;
        qryObterTDPERIODO.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryObterTDPERIODO.ParamByName('DTDATAINICIAL').AsString := FormatDateTime('mm/dd/yyyy', pDataInicial);
        qryObterTDPERIODO.ParamByName('DTDATAFINAL').AsString := FormatDateTime('mm/dd/yyyy', pDataFinal);

        qryObterTDPERIODO.Open;

  Result := FsListaLancamentos;
end;


function TdmExportaFinance.obterTitulosReceberProvisionados(pIdOrganizacao,
  pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer;
  var loMostraErros: TFMostraErros): TListaLancamentos;
var
aux :Integer;
begin
 try

          qryTR.Close;
          qryTR.Connection := dmConexao.Conn;
          qryTR.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
          qryTR.ParamByName('pDataInicial').AsDate := pDataInicial;
          qryTR.ParamByName('pDataFinal').AsDate := pDataFinal;
          qryTR.Open;

       //convertendo para lista
          if not qryTR.IsEmpty then
          begin
            FsListaLancamentos := convertTRPROVToLancamentoMega('TR',pIdOrganizacao, pAno, pCodEmpresa, pLote, qryTR, loMostraErros);
          end;

  except

    raise(Exception).Create('Problemas ao tentar exportar TITULOS A PAGAR PROVISIONADOS');

  end;

  Result := FsListaLancamentos;

end;
function TdmExportaFinance.obterTodosLoteContabil(pIdOrganizacao: string;
  pDataInicial, pDataFinal: TDate): boolean;
begin

  try
        qryObterTodosLoteContabil.Connection := dmConexao.Conn;
        qryObterTodosLoteContabil.Close;
        qryObterTodosLoteContabil.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryObterTodosLoteContabil.ParamByName('DTDATAINICIAL').AsString := FormatDateTime('mm/dd/yyyy', pDataInicial);
        qryObterTodosLoteContabil.ParamByName('DTDATAFINAL').AsString := FormatDateTime('mm/dd/yyyy', pDataFinal);

        qryObterTodosLoteContabil.Open;

  except
    raise(Exception).Create('Problemas ao OBTER TODOS OS LOTES CONTÁBEIS');
  end;

  Result := not qryObterTodosLoteContabil.IsEmpty;

end;

//obter valor do debito por tipo operacao bancaria
function TdmExportaFinance.obterValorDebitoGenericTOB(pIdOrganizacao, pTable, pCampo, pTipo: string; pDataInicial, pDataFinal: TDate): Currency;
  var
  comando : string;
begin
   //  pDataInicial := StrToDate(FormatDateTime('dd/mm/yyyy', pDataInicial));
    // pDataFinal := StrToDate(FormatDateTime('dd/mm/yyyy', pDataFinal));

  dmConexao.conectarBanco;
 comando :='SELECT Sum(' + pcampo +') as VALOR_DEBITO ' +
           'FROM ' + pTable + ' as TB '+
           'WHERE TB.DATA_MOVIMENTO BETWEEN :DTDATAINICIAL AND :DTDATAFINAL '+
           'AND TB.ID_ORGANIZACAO=:PIDORGANIZACAO ' +
           'AND TB.ID_TIPO_OPERACAO_BANCARIA = :PTOB '+
           'AND TB.ID_LOTE_CONTABIL IS NULL ';

   try

            qryObterValorDebitoGeneric.Close;
            qryObterValorDebitoGeneric.Connection := dmConexao.Conn;
            qryObterValorDebitoGeneric.SQL.Clear;
            qryObterValorDebitoGeneric.SQL.Add(comando);
            qryObterValorDebitoGeneric.ParamByName('PIDORGANIZACAO').AsString := PIDORGANIZACAO;
            qryObterValorDebitoGeneric.ParamByName('PTOB').AsString := pTipo;
            qryObterValorDebitoGeneric.ParamByName('DTDATAINICIAL').AsDate := pDataInicial;
            qryObterValorDebitoGeneric.ParamByName('DTDATAFINAL').AsDate := pDataFinal;

            qryObterValorDebitoGeneric.Open;

            Result := qryObterValorDebitoGeneric.FieldByName('VALOR_DEBITO').AsCurrency;

  except
    raise(Exception).Create('Problemas ao OBTER VALOR DEBITO POR TIPO OPERACAO BANCARIA');
  end;
end;





 function TdmExportaFinance.obterValorDebitoGeneric(pIdOrganizacao, pTable, pCampoSum, pCampoData: string; pDataInicial, pDataFinal: TDate): Currency;
  var
  comando : string;
begin
    // pDataInicial := StrToDate(FormatDateTime('dd/mm/yyyy', pDataInicial));
   //  pDataFinal := StrToDate(FormatDateTime('dd/mm/yyyy', pDataFinal));

 comando :='SELECT Sum(' + pCampoSum +') as VALOR_DEBITO ' +
           'FROM ' + pTable + ' as TB '+
           'WHERE TB.'+ pCampoData + '  BETWEEN :DTDATAINICIAL AND :DTDATAFINAL '+
           'AND TB.ID_ORGANIZACAO=:PIDORGANIZACAO ' +
           'AND TB.ID_LOTE_CONTABIL IS NULL ';


    try
          qryObterValorDebitoGeneric.Close;
          qryObterValorDebitoGeneric.Connection := dmConexao.Conn;
          qryObterValorDebitoGeneric.SQL.Clear;
          qryObterValorDebitoGeneric.SQL.Add(comando);
          qryObterValorDebitoGeneric.ParamByName('PIDORGANIZACAO').AsString := PIDORGANIZACAO;
          qryObterValorDebitoGeneric.ParamByName('DTDATAINICIAL').AsDate := pDataInicial;
          qryObterValorDebitoGeneric.ParamByName('DTDATAFINAL').AsDate := pDataFinal;


          qryObterValorDebitoGeneric.Open;

          Result := qryObterValorDebitoGeneric.FieldByName('VALOR_DEBITO').AsCurrency;

      except
        raise(Exception).Create('Problemas ao OBTER VALOR DEBITO GENERICO');
      end;





end;

function TdmExportaFinance.updateIDLoteContabilGeneric(pTable, pIdOrganizacao,  pIdRegistro, pIdLote, registroProvisao: string): Boolean;
var
  comando : string;
begin
  comando := ' UPDATE ' + pTable + ' SET  ID_LOTE_CONTABIL = ' + QuotedStr(pIdLote) +
             ' WHERE (ID_' + pTable + ' = ' + QuotedStr(pIdRegistro) + ') AND (ID_ORGANIZACAO = ' + QuotedStr(pIdOrganizacao) + ' )';


  if (pTable = 'TITULO_PAGAR') then begin //se for titulo pagar provisionado sem baixa
      if not ( (registroProvisao = '0') or  (registroProvisao = '')  ) then begin

        comando := ' UPDATE ' + pTable + ' SET ID_LOTE_TPB = ' + QuotedStr(pIdLote) +
                   ' WHERE ( REGISTRO_PROVISAO = ' + QuotedStr(registroProvisao) + ') AND (ID_ORGANIZACAO = ' + QuotedStr(pIdOrganizacao) + ' )';
      end;

  end;


  if (pTable = 'TITULO_RECEBER') then begin
      if not ( (registroProvisao = '0') or  (registroProvisao = '')  ) then begin

       comando := ' UPDATE ' + pTable + ' SET  ID_LOTE_CONTABIL = ' + QuotedStr(pIdLote) +
               ' WHERE ( REGISTRO_PROVISAO = ' + QuotedStr(registroProvisao) + ') AND (ID_ORGANIZACAO = ' + QuotedStr(pIdOrganizacao) + ' )';
      end;
  end;


  try
    qryUpdateGeneric.Close;
    qryUpdateGeneric.Connection := dmConexao.Conn;
    qryUpdateGeneric.SQL.Clear;
    qryUpdateGeneric.SQL.Add(comando);

    qryUpdateGeneric.ExecSQL;
    dmConexao.conn.CommitRetaining;
  except
    raise(Exception).Create('Problemas ao atualizar lote contabil generic ... : ' + pTable );

  end;

  Result := System.True;

end;

procedure TdmExportaFinance.validarLancamentos(pIdOrganizacao: string; plista: TListaLancamentos; pCodeEmpresa: Integer);
var
  I: Integer;
  historico, pendencia, contaCR, contaDB: string;
 pId, qtdPendencia, codreduzCR, codreduzDB: Integer;
  valorCR, valorDB: Currency;
begin
   qtdPendencia := 0;

   if limpaPendentes(pIdOrganizacao) then begin

   qtdPendencia := 0;

   end;

  if plista <> nil then
  begin

    for I := 0 to TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Count - 1 do
    begin
      historico := TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Items[I]).Historico;
      contaCR :=    TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Items[I]).ContaCredito;
      codreduzCR := TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Items[I]).CodReduzCre;
      valorCR :=    TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Items[I]).Valor;
      contaDB :=    TLancamentoDebitoModel(TListaLancamentoDebito(plista.ListaDebito[0]).FListaLancamentoDebito.Items[I]).ContaDebito;
      codreduzDB := TLancamentoDebitoModel(TListaLancamentoDebito(plista.ListaDebito[0]).FListaLancamentoDebito.Items[I]).CodReduzDeb;
      valorDB :=    TLancamentoDebitoModel(TListaLancamentoDebito(plista.ListaDebito[0]).FListaLancamentoDebito.Items[I]).Valor;
      pId     :=  dmMegaContabil.retornarIDPorTabela('');
      if valorCR <> valorDB then
      begin
        pendencia := pendencia + 'VALOR CREDITO <> DEBITO';
        qtdPendencia := qtdPendencia + 1;
      end;

      if not dmMegaContabil.locateContaContabil(pCodeEmpresa, contaCR) then
      begin
        pendencia := pendencia + ' /CTA CREDITO NÃO EXISTE -> ' + contaCR;
        qtdPendencia := qtdPendencia + 1;
      end;

      if not dmMegaContabil.locateContaContabil(pCodeEmpresa, contaDB) then
      begin
        pendencia := pendencia + ' /CTA DEBITO NÃO EXISTE -> ' + contaDB;
        qtdPendencia := qtdPendencia + 1;

      end;

      if qtdPendencia > 0 then
      begin
        inserePendente(pIdOrganizacao, historico, TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Items[I]).FncIdentificacao, pendencia, TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Items[I]).Valor);
      end;
    end;

  end;

end;

function TdmExportaFinance.obterTCPorPeriodo(pIdOrganizacao: string; pDataInicial, pDataFinal: TDate): TListaLancamentos;
begin
  FsListaLancamentos := TListaLancamentos.Create;

  if not qryObterTCPERIODO.Connection.Connected then
  begin
    qryObterTCPERIODO.Connection := dmConexao.Conn;
  end;

  qryObterTCPERIODO.Close;
  qryObterTCPERIODO.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
  qryObterTCPERIODO.ParamByName('DTDATAINICIAL').AsString := FormatDateTime('mm/dd/yyyy', pDataInicial);
  qryObterTCPERIODO.ParamByName('DTDATAFINAL').AsString := FormatDateTime('mm/dd/yyyy', pDataFinal);

  qryObterTCPERIODO.Open;

  //Result := not qryObterTCPERIODO.IsEmpty;
  Result := FsListaLancamentos;
end;


function TdmExportaFinance.gravarLoteContabil(pIdLote, pIdOrganizacao, pLote, pDataInicial, pDataFinal: string; pLista :TListaLancamentos; pTable :string; qtdRegistros :Integer; valorDebito, valorCredito : Currency): Boolean;
var
 registroProvisao, pUsuario,pStatus,pDataRegistro,pDataAtualizacao, idRegistro, comando, station: string;
tamLista, linha, lancamentoCR, listaCR,lancamentoDB,listaDB, I :Integer;
begin

   tamLista:=0;  linha :=0;    listaCR :=0;  lancamentoCR :=0;  listaDB :=0;  lancamentoDB :=0;

//  qtdRegistros := TListaLancamentoCredito(plista.ListaCredito[0]).FListaLancamentoCredito.Count;
  qtdRegistros  := TListaLancamentoDebito(pLista).Count ;
   // cada tipo de lancamento

  pUsuario := uUtil.TUserAtual.getUserId;
  pStatus := 'EXPORT/AUTO';
  station := Uutil.GetComputerNetName;
  pDataRegistro := FormatDateTime('dd/mm/yyyy', uUtil.getDataServer);
  pDataAtualizacao := FormatDateTime('dd/mm/yyyy', uUtil.getDataServer);

  comando := 'INSERT INTO LOTE_CONTABIL (ID_LOTE_CONTABIL,ID_ORGANIZACAO, LOTE, STATUS, '
           + 'ID_USUARIO, PERIODO_INICIAL, PERIODO_FINAL, DATA_REGISTRO, DATA_ATUALIZACAO, '
           + 'TIPO_TABLE, QTD_REGISTROS, VALOR_DB, VALOR_CR ) '
           + 'VALUES (:pIdLote, :pIdOrganizacao, :pLote, :pStatus, :pUsuario, '
           + ':pDataInicial,:pDataFinal,:pDataRegistro,:pDataAtualizacao, :pTable, :pQtdRegistros, :pValorDB, :pValorCR )';

  try
    qryGravarLoteContabil.Close;
    qryGravarLoteContabil.Connection := dmConexao.Conn;
    qryGravarLoteContabil.SQL.Clear;
    qryGravarLoteContabil.SQL.Add(comando);
    qryGravarLoteContabil.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
    qryGravarLoteContabil.ParamByName('pIdLote').AsString := pIdLote;
    qryGravarLoteContabil.ParamByName('pLote').AsString := pLote;
    qryGravarLoteContabil.ParamByName('pStatus').AsString := pStatus;
    qryGravarLoteContabil.ParamByName('pUsuario').AsInteger := StrToInt(pUsuario);
    qryGravarLoteContabil.ParamByName('pDataRegistro').AsDate := StrToDate(pDataRegistro);
    qryGravarLoteContabil.ParamByName('pDataInicial').AsDate := StrToDate(pDataInicial);
    qryGravarLoteContabil.ParamByName('pDataFinal').AsDate := StrToDate(pDataFinal);
    qryGravarLoteContabil.ParamByName('pDataAtualizacao').AsDate := StrToDate(pDataAtualizacao);
    qryGravarLoteContabil.ParamByName('pTable').AsString := pTable;
    qryGravarLoteContabil.ParamByName('pQtdRegistros').AsInteger := qtdRegistros;
    qryGravarLoteContabil.ParamByName('pValorDB').AsCurrency := valorDebito;
    qryGravarLoteContabil.ParamByName('pValorCR').AsCurrency := valorCredito;

    qryGravarLoteContabil.ExecSQL;
    dmConexao.conn.CommitRetaining;

  // pegar a lista e alterar os lancamentos para terem o id do lote marcado.

    if pLista <> nil then
    begin
        tamLista := TListaLancamentoCredito(pLista).Count ;   //usado só na barra de progresso

          for   listaCR := 0 to TListaLancamentoCredito(pLista).Count -1 do begin
            for lancamentoCR := 0 to TListaLancamentoCredito(pLista.ListaCredito[listaCR]).FListaLancamentoCredito.Count  - 1 do
            begin

                  idRegistro       := TLancamentoCreditoModel(TListaLancamentoCredito(pLista.ListaCredito[listaCR]).FListaLancamentoCredito.Items[lancamentoCR]).IdRegistroFinance;
                  registroProvisao := TLancamentoCreditoModel(TListaLancamentoCredito(plista.ListaCredito[listaCR]).FListaLancamentoCredito.Items[lancamentoCR]).RegistroProvisao;

                  updateIDLoteContabilGeneric(pTable, pIdOrganizacao, idRegistro, pIdLote,registroProvisao );

              end;
           end;

            for   listaDB := 0 to TListaLancamentoDebito(pLista).Count -1 do begin
            for lancamentoDB := 0 to TListaLancamentoDebito(pLista.listaDebito[listaDB]).FListaLancamentoDebito.Count  - 1 do
            begin

                  idRegistro       := TLancamentoDebitoModel(TListaLancamentoDebito(pLista.listaDebito[listaDB]).FListaLancamentoDebito.Items[lancamentoDB]).IdRegistroFinance;
                  registroProvisao := TLancamentoDebitoModel(TListaLancamentoDebito(pLista.listaDebito[listaDB]).FListaLancamentoDebito.Items[lancamentoDB]).RegistroProvisao;

                  updateIDLoteContabilGeneric(pTable, pIdOrganizacao, idRegistro, pIdLote,registroProvisao );

              end;
           end;

    end;

    Result := System.True;

  except
    dmConexao.conn.RollbackRetaining;
    raise(Exception).Create('Problemas ao GRAVAR LOTE CONTABIL FNC.');
  end;
end;

function TdmExportaFinance.inserePendente(pIdOrganizacao, pTIPO, pIDENTIFICACAO, pPENDENCIA: string; pVALOR: Currency): Boolean;
var
  pID, comando: string;
begin

  comando := ' INSERT INTO LANC_EXPORT_PEND (ID_ORGANIZACAO,ID, VALOR, TIPO, IDENTIFICACAO, PENDENCIA, DATA_REGISTRO) ' +
             ' VALUES (:PIDORGANIZACAO, :pID, :pVALOR, :pTIPO, :pIDENTIFICACAO, :pPENDENCIA, :pDATAREGISTRO) ';


   pID := Copy(PIDORGANIZACAO + pIDENTIFICACAO + pTIPO,1,34) ;
   pID := dmConexao.obterNewID;

  try
    qryInserePendente.Close;
    qryInserePendente.Connection := dmConexao.Conn;
    qryInserePendente.SQL.Clear;
    qryInserePendente.SQL.Add(comando);
    qryInserePendente.ParamByName('PIDORGANIZACAO').AsString := PIDORGANIZACAO;
    qryInserePendente.ParamByName('pID').AsString := pID;
    qryInserePendente.ParamByName('pTIPO').AsString := pTIPO;
    qryInserePendente.ParamByName('pVALOR').AsCurrency := pVALOR;
    qryInserePendente.ParamByName('pIDENTIFICACAO').AsString := pIDENTIFICACAO;
    qryInserePendente.ParamByName('pPENDENCIA').AsString := pPENDENCIA;
    qryInserePendente.ParamByName('pDATAREGISTRO').AsDate := Now;

    qryInserePendente.ExecSQL;
  except
    raise(Exception).Create('Problemas ao inserir lancamentos PENDENTES.');
  end;

  Result := System.True;

end;

function TdmExportaFinance.limpaPendentes(pIdOrganizacao: string): Boolean;
begin
       //deleta todos os registros existentes até ontem. (current_date -1)
  try

    qryLimparPendentes.Connection := dmConexao.Conn;
    qryLimparPendentes.Close;
    qryLimparPendentes.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;

    qryLimparPendentes.ExecSQL;
    dmConexao.conn.CommitRetaining;


  except
    dmConexao.conn.RollbackRetaining;
    raise(Exception).Create('Problemas ao LIMPAR PENDENTES.');
  end;

  Result := System.True;

end;

procedure TdmExportaFinance.inicializarDM(Sender: TObject);
begin
 { if not (Assigned(dmConexao)) then
  begin
    dmConexao := TdmConexao.Create(Self);
  end
  else
  begin
    dmConexao.conectarBanco;
  end;   }

  dmConexao.conectarBanco;

  if not (Assigned(dmMegaContabil)) then
  begin
    dmMegaContabil := TdmMegaContabil.Create(Self);
    dmConexao.conectarMega;

  end;

end;

function TdmExportaFinance.convertTFDQueryToLancamentoMega(pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery): TListaLancamentos;
var
  pCodigoReduzidoDB, pCodigoReduzidoCR,  aux: Integer;
  tempLancamentoCR: TLancamentoCreditoModel;
  tempLancamentoDB: TLancamentoDebitoModel;
  loMostraErros: TFMostraErros;
begin

  try
    FsListaLancamentos := TListaLancamentos.Create;
    FsListaCredito := TListaLancamentoCredito.Create;
    FsListaDebito := TListaLancamentoDebito.Create;
    pCodigoReduzidoCR :=0;
    pCodigoReduzidoDB :=0;

//obtendo lancamentos de lista de creditos
    query.First;
    while (not query.Eof) do
    begin

      tempLancamentoDB := TLancamentoDebitoModel.Create;
      tempLancamentoCR := TLancamentoCreditoModel.Create;
      tempLancamentoCR.SetAno(pAno);
      tempLancamentoCR.SetLote(pLote);
      tempLancamentoCR.SetIdEmpresa(pCodEmpresa);
      tempLancamentoCR.SetFilial(0);
      tempLancamentoCR.SetCentroCusto(0);
      tempLancamentoCR.SetDataLanc(uUtil.getDataServer); 
      tempLancamentoCR.SetValor(query.FieldByName('VALOR').AsCurrency);
      tempLancamentoCR.SetData(query.FieldByName('DATA').AsDateTime);
      tempLancamentoCR.SetCodHistorico(query.FieldByName('CDHIST').AsInteger);
      tempLancamentoCR.SetComplemento(query.FieldByName('COMPL').AsString + ' ' + query.FieldByName('CTAORIGEM').AsString + ' --> ' + query.FieldByName('CTADESTINO').AsString );
      tempLancamentoCR.SetHistorico(query.FieldByName('HISTORICO').AsString);
      tempLancamentoCR.SetIdRegistroFinance(query.FieldByName('ID').AsString);
      tempLancamentoCR.SetFncIdentificacao(query.FieldByName('IDENTIFCRE').AsString);
      tempLancamentoCR.SetTipo('2');  //1 - DEBITO  - 2 - CREDITO
      tempLancamentoCR.SetExecTrigger('S'); //S sempre

       pCodigoReduzidoCR := query.FieldByName('CDREDUZCRE').AsInteger;

       if ( pCodigoReduzidoCR = 0)  then begin   //não pode ser zero
          raise Exception.Create('Erro ao obter o código reduzido.  '  + tempLancamentoCR.Complemento );
       end;

       if not obterContaMegaPorCodigo(pCodEmpresa,pCodigoReduzidoCR)  then begin

          raise Exception.Create('Erro ao obter o código reduzido. ' + tempLancamentoCR.Complemento );

       end else begin

        tempLancamentoCR.SetCodReduzCre(pCodigoReduzidoCR);

        tempLancamentoCR.SetDgCodReduzCre(qryExistCODREDUZ.FieldByName('DGREDUZ').AsString);
        tempLancamentoCR.SetContaCredito(qryExistCODREDUZ.FieldByName('CONTA').AsString);
        tempLancamentoCR.SetDgContaCredito(qryExistCODREDUZ.FieldByName('DGVER').AsString);

       end;
          

      FsListaCredito.Adicionar(tempLancamentoCR);

    //linha do debito

      // tempLancamentoCR.SetIdLancamento(); gerado antes de inserir
     //  tempLancamentoCR.SetLinha();gerado antes de inserir
      tempLancamentoDB.SetAno(pAno);
      tempLancamentoDB.SetLote(pLote);
      tempLancamentoDB.SetIdEmpresa(pCodEmpresa);
      tempLancamentoDB.SetFilial(0);
      tempLancamentoDB.SetCentroCusto(0);
      tempLancamentoDB.SetDataLanc(uUtil.getDataServer);
      tempLancamentoDB.SetValor(query.FieldByName('VALOR').AsCurrency);
      tempLancamentoDB.SetData(query.FieldByName('DATA').AsDateTime);
     { 
      tempLancamentoDB.SetContaDebito(query.FieldByName('CONTA_DEB').AsString);
      tempLancamentoDB.SetDgContaDebito(query.FieldByName('DGDEB').AsString);
      tempLancamentoDB.SetCodReduzDeb(query.FieldByName('CDREDUZDEB').AsInteger);
      tempLancamentoDB.SetDgCodReduzDeb(query.FieldByName('DGREDUZDEB').AsString); }

      tempLancamentoDB.SetCodHistorico(query.FieldByName('CDHIST').AsInteger);
      tempLancamentoDB.SetComplemento(query.FieldByName('COMPL').AsString);
      tempLancamentoDB.SetHistorico(query.FieldByName('HISTORICO').AsString);
      tempLancamentoDB.SetIdRegistroFinance(query.FieldByName('ID').AsString);
      tempLancamentoDB.SetFncIdentificacao(query.FieldByName('IDENTIFDEB').AsString);
      tempLancamentoDB.SetTipo('1');   //1 - DEBITO  - 2 - CREDITO
      tempLancamentoDB.SetExecTrigger('S'); //S sempre

      
       pCodigoReduzidoDB := query.FieldByName('CDREDUZDEB').AsInteger;

       if ( pCodigoReduzidoDB = 0)  then begin   //não pode ser zero
          raise Exception.Create('Erro ao obter o código reduzido.  '  + tempLancamentoDB.Complemento );
       end;

       if not obterContaMegaPorCodigo(pCodEmpresa,pCodigoReduzidoDB)  then begin

          raise Exception.Create('Erro ao obter o código reduzido. ' + tempLancamentoDB.Complemento );

       end else begin

        tempLancamentoDB.SetCodReduzDeb(pCodigoReduzidoDB);

        tempLancamentoDB.SetDgCodReduzDeb(qryExistCODREDUZ.FieldByName('DGREDUZ').AsString);
        tempLancamentoDB.SetContaDebito(qryExistCODREDUZ.FieldByName('CONTA').AsString);
        tempLancamentoDB.SetDgContaDebito(qryExistCODREDUZ.FieldByName('DGVER').AsString);

       end;   

      FsListaDebito.Adicionar(tempLancamentoDB);

      query.Next;
    end;

    FsListaLancamentos.AdicionarCredito(FsListaCredito);
    FsListaLancamentos.AdicionarDebito(FsListaDebito);

  except
    raise(Exception).Create(' Problemas ao converter lancamentos. ');
//    on E: Exception do
//    E.Message ;
  end;

  //validar as duas listas
  //1- garantir que o valor de credito e de debito sao iguais
  //2- garantir que a conta contabil exista no MEGA
  //3- garantir que a conta reduzida exista no MEGA
 //suspendo em 03/10 para verificação
 //  validarLancamentos(pIdOrganizacao, FsListaLancamentos, pCodEmpresa);

  Result := FsListaLancamentos;

end;



function TdmExportaFinance.convertTPROVToLancamentoMega(pTipoTitulo,pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery; var loMostraErros: TFMostraErros): TListaLancamentos;
var
 qtdParcelas, aux: Integer;
  tempLancamentoCR: TLancamentoCreditoModel;
  tempLancamentoDB: TLancamentoDebitoModel;
//  loMostraErros: TFMostraErros;
 pRegistroProvisao, pID, pID_ORG, cmd :string;
  //campos necessarios para preencher o credito
  VALOR: Currency; fData: TDate;
   CDHIST,CDREDUZDEB, CDREDUZCRE: Integer;
  IDENTIFCRE, ID,HISTORICO, COMPL,DGREDUZCRE, DGCRE,CONTA_CRE :string;
  IDENTIFDEB, DGREDUZDEB ,DGDEB, CONTA_DEB :string;
  pCodigoReduzidoCR,   pCodigoReduzidoDB :Integer;
  
   
  // query contem os titulos pagos/recebidos que foram provisionados apenas
  // no caso do TITULO A PAGAR
  // a consulta deve trazer todos os titulos pagos ou nao
  // conta credito fica no cedente
  //conta debito fica no rateio de historicos (tabela titulo_pagar_historico)


begin

  try
    FsListaLancamentos := TListaLancamentos.Create;
    FsListaCredito := TListaLancamentoCredito.Create;
    FsListaDebito := TListaLancamentoDebito.Create;


    query.First; //contem alguns dados do TITULO
    //precisa consultar os creditos e debitos
    while (not query.Eof) do
       begin
          pCodigoReduzidoCR :=0;
          pCodigoReduzidoDB :=0;
       
             pID               := query.FieldByName('ID').AsString;
             pID_ORG           := query.FieldByName('ID_ORGANIZACAO').AsString;
           //  qtdParcelas       := query.FieldByName('QTD').AsInteger;
             fData             := query.FieldByName('DATA_EMISSAO').AsDateTime;
             pRegistroProvisao := query.FieldByName('REGISTRO_PROVISAO').AsString;
             
          if(pTipoTitulo.Equals('TP')) then begin
              //CREDITO = CONTA CONTABIL DO CEDENTE
            try
                qryTPPROVCR.Close;
                qryTPPROVCR.Connection := dmConexao.Conn;
                qryTPPROVCR.ParamByName('PIDORGANIZACAO').AsString := pID_ORG;
                qryTPPROVCR.ParamByName('pID').AsString := pID;            
                qryTPPROVCR.Open;                

                if not qryTPPROVCR.IsEmpty then begin

                  qryTPPROVCR.First;
                   while not qryTPPROVCR.Eof do
                   begin
                       pCodigoReduzidoCR := 0;
                         //preencher as variaveis aqui
                          VALOR       := qryTPPROVCR.FieldByName('VALOR').AsCurrency;  // (qtdParcelas * (qryTPPROVCR.FieldByName('VALOR').AsCurrency));

                          CDREDUZCRE  :=0;
                          IF  NOT (qryTPPROVCR.FieldByName('CDREDUZCRE').AsString = string.Empty ) then begin
                              CDREDUZCRE  := StrToInt(qryTPPROVCR.FieldByName('CDREDUZCRE').AsString);
                          end;

                          IDENTIFCRE  := qryTPPROVCR.FieldByName('IDENTIFCRE').AsString;
                          ID          := qryTPPROVCR.FieldByName('ID').AsString;
                          HISTORICO   := qryTPPROVCR.FieldByName('HISTORICO').AsString;
                          COMPL       := qryTPPROVCR.FieldByName('COMPL').AsString;
                          CDHIST      := qryTPPROVCR.FieldByName('CDHIST').AsInteger;
                          DGREDUZCRE  := qryTPPROVCR.FieldByName('DGREDUZCRE').AsString;
                          DGCRE       := qryTPPROVCR.FieldByName('DGCRE').AsString;
                          CONTA_CRE   := qryTPPROVCR.FieldByName('CONTA_CRE').AsString;

                          IDENTIFDEB  := IDENTIFCRE;
                           
                          tempLancamentoCR := TLancamentoCreditoModel.Create;
                          tempLancamentoCR.SetAno(pAno);
                          tempLancamentoCR.SetLote(pLote);
                          tempLancamentoCR.SetIdEmpresa(pCodEmpresa);
                          tempLancamentoCR.SetFilial(0);
                          tempLancamentoCR.SetCentroCusto(0);
                          tempLancamentoCR.SetDataLanc(uUtil.getDataServer);
                          tempLancamentoCR.SetValor(VALOR);
                          tempLancamentoCR.SetData(fData);
                          
                          tempLancamentoCR.SetCodHistorico(CDHIST);
                          tempLancamentoCR.SetComplemento(COMPL);
                          tempLancamentoCR.SetHistorico(HISTORICO);
                          tempLancamentoCR.SetIdRegistroFinance(ID);
                          tempLancamentoCR.SetRegistroProvisao(pRegistroProvisao);
                          tempLancamentoCR.SetFncIdentificacao(IDENTIFCRE);
                          tempLancamentoCR.SetTipo('2');  //1 - DEBITO  - 2 - CREDITO
                          tempLancamentoCR.SetExecTrigger('S'); //S sempre

                        {  
                          tempLancamentoCR.SetContaCredito(CONTA_CRE) ;
                          tempLancamentoCR.SetDgContaCredito(DGCRE);
                          tempLancamentoCR.SetCodReduzCre(CDREDUZCRE);
                          tempLancamentoCR.SetDgCodReduzCre(DGREDUZCRE);  }


                         
                           pCodigoReduzidoCR := CDREDUZCRE;

                           if ( pCodigoReduzidoCR = 0)  then begin   //não pode ser zero
                              raise Exception.Create('Erro ao obter o código reduzido.  '  + tempLancamentoCR.Complemento );
                           end;

                           if not obterContaMegaPorCodigo(pCodEmpresa,pCodigoReduzidoCR)  then begin

                              raise Exception.Create('Erro ao obter o código reduzido. ' + tempLancamentoCR.Complemento );

                           end else begin

                            tempLancamentoCR.SetCodReduzCre(pCodigoReduzidoCR);

                            tempLancamentoCR.SetDgCodReduzCre(qryExistCODREDUZ.FieldByName('DGREDUZ').AsString);
                            tempLancamentoCR.SetContaCredito(qryExistCODREDUZ.FieldByName('CONTA').AsString);
                            tempLancamentoCR.SetDgContaCredito(qryExistCODREDUZ.FieldByName('DGVER').AsString);

                           end;
                          
                                                   

                      FsListaCredito.Adicionar(tempLancamentoCR);

                    qryTPPROVCR.Next;
                   end;                  
                end;                        
             except
              raise(Exception).Create('Problemas ao consultar créditos do TP.  ' + pID);
             end;
          end;
         //obtendo os creditos  


    //linha do debito

              TRY
                qryTPPROVDB.Close;
                qryTPPROVDB.Connection := dmConexao.Conn;
                qryTPPROVDB.ParamByName('PIDORGANIZACAO').AsString := pID_ORG;
                qryTPPROVDB.ParamByName('pID').AsString := pID;
                qryTPPROVDB.Open;
              except

              raise(Exception).Create('Problemas ao consultar débitos do TP.');

              end;

         if not qryTPPROVDB.IsEmpty then begin

            qryTPPROVDB.First;
            while not qryTPPROVDB.Eof do
            begin


                 VALOR       := qryTPPROVDB.FieldByName('VALOR').AsCurrency; //(qtdParcelas * (qryTPPROVDB.FieldByName('VALOR').AsCurrency));
                 ID          := qryTPPROVDB.FieldByName('ID').AsString;
                 HISTORICO   := qryTPPROVDB.FieldByName('HISTORICO').AsString;
                 COMPL       := qryTPPROVDB.FieldByName('COMPL').AsString;
                 CDHIST      := qryTPPROVDB.FieldByName('CDHIST').AsInteger;

                 CDREDUZDEB  :=0;
                          IF  NOT (qryTPPROVDB.FieldByName('CDREDUZDEB').AsString = string.Empty ) then begin
                              CDREDUZDEB  := StrToInt(qryTPPROVDB.FieldByName('CDREDUZDEB').AsString);
                          end;

                 DGREDUZDEB  := qryTPPROVDB.FieldByName('DGREDUZDEB').AsString;
                 DGDEB       := qryTPPROVDB.FieldByName('DGDEB').AsString;
                 CONTA_DEB   := qryTPPROVDB.FieldByName('CONTA_DEB').AsString;


                tempLancamentoDB := TLancamentoDebitoModel.Create;
                tempLancamentoDB.SetAno(pAno);
                tempLancamentoDB.SetLote(pLote);
                tempLancamentoDB.SetIdEmpresa(pCodEmpresa);
                tempLancamentoDB.SetFilial(0);
                tempLancamentoDB.SetCentroCusto(0);
                tempLancamentoDB.SetDataLanc(uUtil.getDataServer);
                tempLancamentoDB.SetValor(VALOR);
                tempLancamentoDB.SetData(fData);

                tempLancamentoDB.SetCodHistorico(CDHIST);
                tempLancamentoDB.SetComplemento(COMPL);
                tempLancamentoDB.SetHistorico(HISTORICO);
                tempLancamentoDB.SetIdRegistroFinance(ID);
                tempLancamentoDB.SetRegistroProvisao(pRegistroProvisao);
                tempLancamentoDB.SetFncIdentificacao(IDENTIFDEB);
                tempLancamentoDB.SetTipo('1');   //1 - DEBITO  - 2 - CREDITO
                tempLancamentoDB.SetExecTrigger('S'); //S sempre


              {  
                tempLancamentoDB.SetContaDebito(CONTA_DEB);
                tempLancamentoDB.SetDgContaDebito(DGDEB);
                tempLancamentoDB.SetCodReduzDeb(CDREDUZDEB);
                tempLancamentoDB.SetDgCodReduzDeb(DGREDUZDEB);  }

                  pCodigoReduzidoDB := CDREDUZDEB;

               if ( pCodigoReduzidoDB = 0)  then begin   //não pode ser zero
                  raise Exception.Create('Erro ao obter o código reduzido.  '  + tempLancamentoDB.Complemento );
               end;

               if not obterContaMegaPorCodigo(pCodEmpresa,pCodigoReduzidoDB)  then begin

                  raise Exception.Create('Erro ao obter o código reduzido. ' + tempLancamentoDB.Complemento );

               end else begin

                tempLancamentoDB.SetCodReduzDeb(pCodigoReduzidoDB);

                tempLancamentoDB.SetDgCodReduzDeb(qryExistCODREDUZ.FieldByName('DGREDUZ').AsString);
                tempLancamentoDB.SetContaDebito(qryExistCODREDUZ.FieldByName('CONTA').AsString);
                tempLancamentoDB.SetDgContaDebito(qryExistCODREDUZ.FieldByName('DGVER').AsString);

               end;   

             
                

              FsListaDebito.Adicionar(tempLancamentoDB);

              qryTPPROVDB.Next;

            end;

         end;

      query.Next;
    end;

    FsListaLancamentos.AdicionarCredito(FsListaCredito);
    FsListaLancamentos.AdicionarDebito(FsListaDebito);

  except
    raise(Exception).Create('Problemas ao converter lancamentos.');
//    on E: Exception do
//    E.Message ;
  end;

  //validar as duas listas
  //1- garantir que o valor de credito e de debito sao iguais
  //2- garantir que a conta contabil exista no MEGA
  //3- garantir que a conta reduzida exista no MEGA
   validarLancamentos(pIdOrganizacao, FsListaLancamentos, pCodEmpresa);

  Result := FsListaLancamentos;

end;




function TdmExportaFinance.obterListaHistoricoSemContaContabil(pIdOrganizacao: String): Boolean;
begin
  Result := False;
  //inicializarDM(Self);
  if dmConexao.conectarBanco then
  begin
    qryHstSemCC.Close;
    qryHstSemCC.Connection := dmConexao.Conn;
    qryHstSemCC.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
    qryHstSemCC.Open;

    Result := not qryHstSemCC.IsEmpty;

  end;
end;

//Transferencia da tesouraria para o banco
function TdmExportaFinance.obterCaixaBancoPorPeriodo(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
begin
   //'DEPOSITO TESOURARIA/BANCO

   try

    FsListaLancamentos := TListaLancamentos.Create;

    qryCaixaBanco.Close;
    qryCaixaBanco.Connection := dmConexao.Conn;
    qryCaixaBanco.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryCaixaBanco.ParamByName('DTDATAINICIAL').AsDate    := pDataInicial;
    qryCaixaBanco.ParamByName('DTDATAFINAL').AsDate      := pDataFinal;
    qryCaixaBanco.Open;

    //convertendo para lista
    if not qryCaixaBanco.IsEmpty then
    begin
      FsListaLancamentos := convertTFDQueryToLancamentoMega(pIdOrganizacao, pAno, pCodEmpresa, pLote, qryCaixaBanco);
    end;
  except

    raise(Exception).Create('Problemas ao tentar exportar lançamentos Transf. Tesouraria para o Banco');

  end;

  Result := FsListaLancamentos;
end;


//Transferencia do banco para a tesouraria
function TdmExportaFinance.obterTBTPorPeriodo(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
  begin
  try

    FsListaLancamentos := TListaLancamentos.Create;

    if not qryBancoCaixa.Connection.Connected then
    begin
      qryBancoCaixa.Connection := dmConexao.Conn;
    end;

    qryBancoCaixa.Close;
    qryBancoCaixa.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
    qryBancoCaixa.ParamByName('DTDATAINICIAL').AsDate    := pDataInicial;
    qryBancoCaixa.ParamByName('DTDATAFINAL').AsDate      := pDataFinal;
    qryBancoCaixa.Open;

    //convertendo para lista
    if not qryBancoCaixa.IsEmpty then
    begin
      FsListaLancamentos := convertTFDQueryToLancamentoMega(pIdOrganizacao, pAno, pCodEmpresa, pLote, qryBancoCaixa);
    end;
  except

    raise(Exception).Create('Problemas ao tentar exportar lançamentos Transf. Banco Tesouraria');

  end;

  Result := FsListaLancamentos;
end;

//titulos a pagar provisao para exportar


function TdmExportaFinance.obterTPProvCR(pIdOrganizacao,pRegistroProvisao : string ): Boolean;
begin
  Result := false;
  dmConexao.conectarBanco;


  qryTPPROVCR.Close;
  qryTPPROVCR.Connection := dmConexao.Conn;
  qryTPPROVCR.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
  qryTPPROVCR.ParamByName('pregistro').AsString := pRegistroProvisao;
  qryTPPROVCR.Open;

  Result := not qryTPPROVCR.IsEmpty;

end;



function TdmExportaFinance.obterTPProvDB(pIdOrganizacao,pRegistroProvisao : string ): Boolean;
begin
  Result := false;


  if not qryTPPROVDB.Connection.Connected then
  begin
    qryTPPROVDB.Connection := dmConexao.Conn;
  end;

  qryTPPROVDB.Close;
  qryTPPROVDB.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
  qryTPPROVDB.ParamByName('pregistro').AsString := pRegistroProvisao;
  qryTPPROVDB.Open;

  Result := not qryTPPROVDB.IsEmpty;

end;


function TdmExportaFinance.obterTPPROVBase(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
var
aux :Integer;
begin
 try

          qryTPPROVBASE.Close;
          qryTPPROVBASE.Connection := dmConexao.Conn;
          qryTPPROVBASE.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
          qryTPPROVBASE.ParamByName('pDataInicial').AsDate := pDataInicial;
          qryTPPROVBASE.ParamByName('pDataFinal').AsDate := pDataFinal;
          qryTPPROVBASE.Open;

       //convertendo para lista
          if not qryTPPROVBASE.IsEmpty then
          begin
            FsListaLancamentos := convertTPROVToLancamentoMega('TP',pIdOrganizacao, pAno, pCodEmpresa, pLote, qryTPPROVBASE, loMostraErros);
          end;

  except

    raise(Exception).Create('Problemas ao tentar exportar TITULOS A PAGAR PROVISIONADOS');

  end;

  Result := FsListaLancamentos;

end;

 function TdmExportaFinance.obterValorDebitoTPB(pIdOrganizacao, pTable, pCampoSum, pCampoData: string;
                                                pDataInicial, pDataFinal: TDate;isProvisao :Integer ): Currency;
  var
  comando : string;
begin
dmConexao.conectarBanco;
Result := 0;

comando := ' SELECT SUM(TP.valor_nominal) AS VALOR_DEBITO  FROM  titulo_pagar TP ' +
           ' WHERE (TP.data_pagamento  BETWEEN :DTDATAINICIAL AND :DTDATAFINAL )' +
           ' AND   (TP.ID_ORGANIZACAO = :PIDORGANIZACAO )' +
           ' AND   (TP.ID_TIPO_STATUS IN (''QUITADO'' ,''PARCIAL'') )' +
           ' AND   (TP.ID_LOTE_CONTABIL IS null )' ;
        //consulta todos os titulos pagos no periodo . organizacao e nao tenha sido exportado

    try
          qryObterValorTitulo.Close;
          qryObterValorTitulo.Connection := dmConexao.Conn;
          qryObterValorTitulo.SQL.Clear;
          qryObterValorTitulo.SQL.Add(comando);
          qryObterValorTitulo.ParamByName('PIDORGANIZACAO').AsString := PIDORGANIZACAO;
          qryObterValorTitulo.ParamByName('DTDATAINICIAL').AsDate := pDataInicial;
          qryObterValorTitulo.ParamByName('DTDATAFINAL').AsDate := pDataFinal;

          qryObterValorTitulo.Open;
        comando := floatToStr(qryObterValorTitulo.FieldByName('VALOR_DEBITO').AsCurrency);

      except
        raise(Exception).Create('Problemas ao OBTER VALOR DEBITO TPB');
      end;

       Result := qryObterValorTitulo.FieldByName('VALOR_DEBITO').AsCurrency;

end;


 function TdmExportaFinance.obterValorDebitoTitulo(pIdOrganizacao, pTable, pCampoSum, pCampoData: string; pDataInicial, pDataFinal: TDate; isProvisao :Integer): Currency;
  var
  comando : string;
begin
dmConexao.conectarBanco;
    // pegar o valor do debito dos titulos.
    // a pTable pode ser PAGAR e RECBER
    // os titulos podem ser provisionados ou nao. Is_provisao 1 para provisionado e 0 para nao provisinado
     comando :='SELECT Sum(' + pCampoSum +') as VALOR_DEBITO ' +
           'FROM ' + pTable + ' as TB '+
           'WHERE TB.'+ pCampoData + '  BETWEEN :DTDATAINICIAL AND :DTDATAFINAL '+
           'AND TB.ID_ORGANIZACAO = :PIDORGANIZACAO  ' +
           'AND TB.ID_TIPO_STATUS <> :PIDSTATUS ' +
           'AND TB.ID_LOTE_CONTABIL IS NULL ';


      if isProvisao = 1 then begin

       //caso do titulo a pagar

          if pTable.Equals('TITULO_PAGAR') then begin

             comando :='SELECT Sum(' + pCampoSum +') as VALOR_DEBITO ' +
                       'FROM ' + pTable + ' as TB '+
                       'WHERE TB.'+ pCampoData + '  BETWEEN :DTDATAINICIAL AND :DTDATAFINAL '+
                       'AND TB.ID_ORGANIZACAO = :PIDORGANIZACAO  ' +
                       'AND TB.ID_TIPO_STATUS <> :PIDSTATUS ' +
                       'AND TB.ID_LOTE_TPB IS NULL ' +
                       'AND TB.REGISTRO_PROVISAO IS NOT NULL ' +
                       'AND TB.ID_LOTE_CONTABIL IS NULL ';
          end;



           if pTable.Equals('TITULO_RECEBER') then begin

             comando :='SELECT Sum(' + pCampoSum +') as VALOR_DEBITO ' +
                       'FROM ' + pTable + ' as TB '+
                       'WHERE TB.'+ pCampoData + '  BETWEEN :DTDATAINICIAL AND :DTDATAFINAL '+
                       'AND TB.ID_ORGANIZACAO = :PIDORGANIZACAO  ' +
                       'AND TB.ID_TIPO_STATUS <> :PIDSTATUS ' +
                       'AND TB.ID_LOTE_TRB IS NULL ' +
                       'AND TB.REGISTRO_PROVISAO IS NOT NULL ' +
                       'AND TB.ID_LOTE_CONTABIL IS NULL ';
          end;

      end;



        try
              qryObterValorTitulo.Close;
              qryObterValorTitulo.Connection := dmConexao.Conn;
              qryObterValorTitulo.SQL.Clear;
              qryObterValorTitulo.SQL.Add(comando);
              qryObterValorTitulo.ParamByName('PIDORGANIZACAO').AsString := PIDORGANIZACAO;
              qryObterValorTitulo.ParamByName('DTDATAINICIAL').AsDate := pDataInicial;
              qryObterValorTitulo.ParamByName('DTDATAFINAL').AsDate := pDataFinal;
              qryObterValorTitulo.ParamByName('PIDSTATUS').AsString := 'EXCLUIDO';

              qryObterValorTitulo.Open;

              Result := qryObterValorTitulo.FieldByName('VALOR_DEBITO').AsCurrency;

          except
            raise(Exception).Create('Problemas ao OBTER VALOR DEBITO GENERICO');
          end;





end;


function TdmExportaFinance.obterValorDebitoTituloProvisao(pIdOrganizacao,
  pTable, pCampoSum, pCampoData: string; pDataInicial, pDataFinal: TDate;
  isProvisao: Integer): Currency;
begin
//teste
end;

function TdmExportaFinance.obterTPB_PROV(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
var
aux :Integer;
begin
 try
          qryTPB.Close;
          qryTPB.Connection := dmConexao.Conn;
          qryTPB.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
          qryTPB.ParamByName('pDataInicial').AsDate := pDataInicial;
          qryTPB.ParamByName('pDataFinal').AsDate := pDataFinal;
          qryTPB.Open;

       //convertendo para lista
          if not qryTPB.IsEmpty then
          begin
          
            FsListaLancamentos := convertTPB_PROVToLancamentoMega('TPB',pIdOrganizacao, pAno, pCodEmpresa, pLote, qryTPB, loMostraErros);
          end;

  except

    raise(Exception).Create('Problemas ao tentar exportar TITULOS A PAGAR PROVISIONADOS');

  end;

  Result := FsListaLancamentos;

end;


function TdmExportaFinance.convertTPB_PROVToLancamentoMega(pTipoTitulo,pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery; var loMostraErros: TFMostraErros): TListaLancamentos;
var
    qtdParcelas, aux: Integer;
    tempLancamentoCR: TLancamentoCreditoModel;
    tempLancamentoDB: TLancamentoDebitoModel;

pIDBAIXA, pRegistroProvisao, pID, pID_ORG, cmd :string;
  VALOR: Currency; fData: TDate;
   CDHIST,CDREDUZDEB, CDREDUZCRE: Integer;
  IDENTIFCRE, ID,HISTORICO, COMPL,DGREDUZCRE, DGCRE,CONTA_CRE :string;
 auxCD, IDENTIFDEB, DGREDUZDEB ,DGDEB, CONTA_DEB, nDOC :string;

  // query contem os titulos pagos/recebidos
  // analisar primeiro o titulo que foi provisionado e está pago
  // se provisionado e pago. .a conta credito fica na parte do pagamento e debito é fornecedor

begin
  try
    FsListaLancamentos := TListaLancamentos.Create;
    FsListaCredito := TListaLancamentoCredito.Create;
    FsListaDebito := TListaLancamentoDebito.Create;

    query.First; //contem alguns dados do TITULO
    //precisa consultar os creditos e debitos
    while (not query.Eof) do
       begin
            VALOR :=0;
             pID               := query.FieldByName('ID').AsString;
             nDoc              := query.FieldByName('NUMERO_DOCUMENTO').AsString;
             pIDBAIXA            := query.FieldByName('IDTPB').AsString;
             pID_ORG           := query.FieldByName('ID_ORGANIZACAO').AsString;
            // qtdParcelas       := query.FieldByName('QTD').AsInteger;
             fData             := query.FieldByName('DATA_PAGAMENTO').AsDateTime;
             pRegistroProvisao := query.FieldByName('REGISTRO_PROVISAO').AsString;
             IDENTIFCRE        := query.FieldByName('NUMERO_DOCUMENTO').AsString;
             IDENTIFDEB        := query.FieldByName('NUMERO_DOCUMENTO').AsString;

             loMostraErros.Add('#### ' + 'TP  ' + nDOC  );
             loMostraErros.Add('BAIXA TP ' +  nDOC + ' VALOR TP ' +  FormatCurr('###,##0.00',query.FieldByName('VALOR').AsCurrency) );
             
       try
              if not Uutil.Empty(pRegistroProvisao) then begin // se tem registro provisao indica que o TP foi provisinando
                //conta debito = ID_conta_contabil_credito do TP (Fornecedor)

                     VALOR       := query.FieldByName('VALOR').AsCurrency;
                     ID          := query.FieldByName('ID').AsString;
                     CDHIST      := query.FieldByName('CDHIST').AsInteger;
                     HISTORICO   := query.FieldByName('HISTORICO').AsString ;
                     COMPL       := query.FieldByName('COMPL').AsString;
                     CDREDUZDEB  := query.FieldByName('CDREDUZDEB').AsInteger;
                     DGREDUZDEB  := query.FieldByName('DGREDUZDEB').AsString;
                     DGDEB       := query.FieldByName('DGDEB').AsString;
                     CONTA_DEB   := query.FieldByName('CONTA_DEB').AsString;

                     loMostraErros.Add('VALOR PROVISAO  ' +  nDOC + ' VALOR PROV ' +  FormatCurr('###,##0.00', VALOR) );

                    FsListaDebito.Adicionar(convertoTPB_PROVToLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                               CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                               DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));

              end  // fim da parte contabil TPB_PROV
              else begin
          //se nao for provisionado, a cointa debito está no rateio de historicos
                if obterTPBHistorico(pID_ORG,pID) then begin
                  //obtendo o rateio de historicos e suas contas contabeis

                   while not qryTPBHistorico.Eof do begin


                       VALOR       := qryTPBHistorico.FieldByName('VALOR').AsCurrency;
                       ID          := query.FieldByName('ID').AsString;

                       HISTORICO   := qryTPBHistorico.FieldByName('HISTORICO').AsString;
                       CDHIST      := qryTPBHistorico.FieldByName('CDHIST').AsInteger;
                       COMPL       := qryTPBHistorico.FieldByName('COMPL').AsString;

                     if HISTORICO.Length >50 then begin

                       HISTORICO   := qryTPBHistorico.FieldByName('HISTORICO').AsString ;
                       COMPL       := Copy(HISTORICO, 50, (HISTORICO.Length-1)) + ' '+ qryTPBHistorico.FieldByName('COMPL').AsString;
                       HISTORICO   := Copy(HISTORICO, 0,48)+'#';

                     end;



                       CDREDUZDEB  := qryTPBHistorico.FieldByName('CDREDUZDEB').AsInteger;

                       DGREDUZDEB  := qryTPBHistorico.FieldByName('DGREDUZDEB').AsString;
                       DGDEB       := qryTPBHistorico.FieldByName('DGDEB').AsString;
                       CONTA_DEB   := qryTPBHistorico.FieldByName('CONTA_DEB').AsString;

                       loMostraErros.Add('HISTORICO  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                      FsListaDebito.Adicionar(convertoTPB_PROVToLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                                 CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                                 DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));
                      qryTPBHistorico.Next;

                   end;

                end;
              end;


              try
                // VERIFICAR SE EXISTEM LANCAMENTOS EM ACRESCIMOS
                //

                 if (obterTPBAC(pID_ORG,pIDBAIXA)) then begin

                  //existem acrescimos  do TP

                  while not qryTPBAcrescimos.Eof do
                      begin

                           VALOR       := qryTPBAcrescimos.FieldByName('VALOR').AsCurrency;
                           ID          := query.FieldByName('ID').AsString;
                           HISTORICO   := qryTPBAcrescimos.FieldByName('HISTORICO').AsString;
                           CDHIST      := qryTPBAcrescimos.FieldByName('CDHIST').AsInteger;
                           COMPL       := qryTPBAcrescimos.FieldByName('COMPL').AsString;
                           CDREDUZDEB  := qryTPBAcrescimos.FieldByName('CDREDUZDEB').AsInteger;
                           DGREDUZDEB  := qryTPBAcrescimos.FieldByName('DGREDUZDEB').AsString;
                           DGDEB       := qryTPBAcrescimos.FieldByName('DGDEB').AsString;
                           CONTA_DEB   := qryTPBAcrescimos.FieldByName('CONTA_DEB').AsString;

                          loMostraErros.Add('ACRESCIMOS  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                          FsListaDebito.Adicionar(convertoTPB_PROVToLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));
                          qryTPBAcrescimos.Next;
                       end;
                end;

             except
              raise(Exception).Create('Problemas ao obter dados dos acréscimos');
             end;



                 //FIM DA PARTE DO DEBITO
                 // consultar os creditos
                 // pega as deducoes
                 // formas de pagamento

             try
                 // obtendo as DEDUCÇõES
                  if (obterTPBDE(pID_ORG,pIDBAIXA)) then begin
                   //pegando as deducoes
                      while not qryTPBDeducao.Eof do begin

                          VALOR       := qryTPBDeducao.FieldByName('VALOR').AsCurrency;
                          CDREDUZCRE  := qryTPBDeducao.FieldByName('CDREDUZCRE').AsInteger;
                          ID          := qryTPBDeducao.FieldByName('ID').AsString;
                          HISTORICO   := qryTPBDeducao.FieldByName('HISTORICO').AsString;
                          COMPL       := qryTPBDeducao.FieldByName('COMPL').AsString;
                          CDHIST      := qryTPBDeducao.FieldByName('CDHIST').AsInteger;
                          DGREDUZCRE  := qryTPBDeducao.FieldByName('DGREDUZCRE').AsString;
                          DGCRE       := qryTPBDeducao.FieldByName('DGCRE').AsString;
                          CONTA_CRE   := qryTPBDeducao.FieldByName('CONTA_CRE').AsString;

                          loMostraErros.Add('DEDUÇÃO  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                          FsListaCredito.Adicionar(convertoTPB_PROVToLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));
                          qryTPBDeducao.Next;

                      end;
                  end;
             except
              raise(Exception).Create('Problemas ao obter dados das deduções ');
             end;

             try
                  //OBTER FORMA DE PAGAMENTO CAIXA
                    if (obterTPBCAIXA(pID_ORG,pIDBAIXA)) then begin
                   //pegando as deducoes
                      while not qryTPBCaixa.Eof do begin

                          VALOR       := qryTPBCaixa.FieldByName('VALOR').AsCurrency;
                          CDREDUZCRE  := qryTPBCaixa.FieldByName('CDREDUZCRE').AsInteger;
                          ID          := qryTPBCaixa.FieldByName('ID').AsString;
                          HISTORICO   := qryTPBCaixa.FieldByName('HISTORICO').AsString;
                          COMPL       := qryTPBCaixa.FieldByName('COMPL').AsString;
                          CDHIST      := qryTPBCaixa.FieldByName('CDHIST').AsInteger;
                          DGREDUZCRE  := qryTPBCaixa.FieldByName('DGREDUZCRE').AsString;
                          DGCRE       := qryTPBCaixa.FieldByName('DGCRE').AsString;
                          CONTA_CRE   := qryTPBCaixa.FieldByName('CONTA_CRE').AsString;

                          loMostraErros.Add('CAIXA  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                          FsListaCredito.Adicionar(convertoTPB_PROVToLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));
                          qryTPBCaixa.Next;

                      end;
                  end;


             except
              raise(Exception).Create('Problemas ao obter dados da baixa por tesouraria ');
             end;
                 try
                   //OBTER FORMA DE PAGAMENTO EM CHERQUE
                    if (obterTPBCHEQUE(pID_ORG,pIDBAIXA)) then begin
                   //pegando as deducoes
                      while not qryTPBCheque.Eof do begin

                          VALOR       := qryTPBCheque.FieldByName('VALOR').AsCurrency;
                          CDREDUZCRE  := qryTPBCheque.FieldByName('CDREDUZCRE').AsInteger;
                          ID          := qryTPBCheque.FieldByName('ID').AsString;
                          HISTORICO   := qryTPBCheque.FieldByName('HISTORICO').AsString;
                          COMPL       := qryTPBCheque.FieldByName('COMPL').AsString;
                          CDHIST      := qryTPBCheque.FieldByName('CDHIST').AsInteger;
                          DGREDUZCRE  := qryTPBCheque.FieldByName('DGREDUZCRE').AsString;
                          DGCRE       := qryTPBCheque.FieldByName('DGCRE').AsString;
                          CONTA_CRE   := qryTPBCheque.FieldByName('CONTA_CRE').AsString;

                          loMostraErros.Add('CHEQUE   ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                          FsListaCredito.Adicionar(convertoTPB_PROVToLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));
                          qryTPBCheque.Next;
                      end;
                  end;
             except
              raise(Exception).Create('Problemas ao obter dados da baixa por cheque');
             end;
                  try
                     //OBTER FORMA DE PAGAMENTO EM INTERNET
                    if (obterTPBINTERNET(pID_ORG,pIDBAIXA)) then begin

                      while not qryTPBInternet.Eof do begin

                          VALOR       := qryTPBInternet.FieldByName('VALOR').AsCurrency;
                          CDREDUZCRE  := qryTPBInternet.FieldByName('CDREDUZCRE').AsInteger;
                          ID          := qryTPBInternet.FieldByName('ID').AsString;
                          HISTORICO   := qryTPBInternet.FieldByName('HISTORICO').AsString;
                          COMPL       := qryTPBInternet.FieldByName('COMPL').AsString;
                          CDHIST      := qryTPBInternet.FieldByName('CDHIST').AsInteger;
                          DGREDUZCRE  := qryTPBInternet.FieldByName('DGREDUZCRE').AsString;
                          DGCRE       := qryTPBInternet.FieldByName('DGCRE').AsString;
                          CONTA_CRE   := qryTPBInternet.FieldByName('CONTA_CRE').AsString;


                          loMostraErros.Add('PAGTO ONLINE   ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                          FsListaCredito.Adicionar(convertoTPB_PROVToLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));



                          qryTPBInternet.Next;

                      end;
                  end;
             except
              raise(Exception).Create('Problemas ao obter dados da baixa internet');
             end;

             except
              raise(Exception).Create('Problemas ao obter dados da baixa');
             end;

      query.Next;
    end;

    FsListaLancamentos.AdicionarCredito(FsListaCredito);
    FsListaLancamentos.AdicionarDebito(FsListaDebito);

  except
    raise(Exception).Create('Problemas ao converter lancamentos.');
//    on E: Exception do
//    E.Message ;
  end;

  //validar as duas listas
  //1- garantir que o valor de credito e de debito sao iguais
  //2- garantir que a conta contabil exista no MEGA
  //3- garantir que a conta reduzida exista no MEGA
  // validarLancamentos(pIdOrganizacao, FsListaLancamentos, pCodEmpresa);

  Result := FsListaLancamentos;

end;

  function TdmExportaFinance.obterTPBAC(pIdOrganizacao, pIdTPB : String): Boolean;
begin
dmConexao.conectarBanco;

  Result := false;
try
  qryTPBAcrescimos.Close;
  qryTPBAcrescimos.Connection := dmConexao.Conn;
  qryTPBAcrescimos.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
  qryTPBAcrescimos.ParamByName('pIdTitutloPagarBaixa').AsString :=
    pIdTPB;
  qryTPBAcrescimos.Open;

except
        raise(Exception).Create('Problemas ao OBTER ACRÉSCIMOS');
end;


  Result := not qryTPBAcrescimos.IsEmpty;
end;

function TdmExportaFinance.convertoTPB_PROVToLancamentoCredito(pCodEmpresa, pLote, pAno, pCodReduzCre,pCodHist: Integer; pHistorico, pComple, pDgCodReduzCre, pContaCre, pDgCre,  pTipo,pIdFinance, pIdentFnc: string; pValor: Currency; pData: TDateTime) : TLancamentoCreditoModel;
var
 tempLancamentoCR : TLancamentoCreditoModel;
 pCodigoReduzidoCR :Integer;
begin
pCodigoReduzidoCR :=0;
      tempLancamentoCR := TLancamentoCreditoModel.Create;
                          tempLancamentoCR.SetAno(IntToStr(pAno));
                          tempLancamentoCR.SetLote(pLote);
                          tempLancamentoCR.SetIdEmpresa(pCodEmpresa);
                          tempLancamentoCR.SetFilial(0);
                          tempLancamentoCR.SetCentroCusto(0);
                          tempLancamentoCR.SetDataLanc(uUtil.getDataServer);
                          tempLancamentoCR.SetValor(pValor);
                          tempLancamentoCR.SetData(pData);
                       {
                          tempLancamentoCR.SetContaCredito(pContaCre) ;
                          tempLancamentoCR.SetDgContaCredito(pDgCre);
                          tempLancamentoCR.SetCodReduzCre(pCodReduzCre);
                          tempLancamentoCR.SetDgCodReduzCre(pDgCodReduzCre); }
                          
                          tempLancamentoCR.SetCodHistorico(pCodHist);
                          tempLancamentoCR.SetComplemento(pComple);
                          tempLancamentoCR.SetHistorico(pHistorico);
                          tempLancamentoCR.SetIdRegistroFinance(pIdFinance);
                          tempLancamentoCR.SetRegistroProvisao('0');
                          tempLancamentoCR.SetFncIdentificacao(pIdentFnc);
                          tempLancamentoCR.SetTipo('2');  //1 - DEBITO  - 2 - CREDITO
                          tempLancamentoCR.SetExecTrigger('S'); //S sempre


                   
        
       pCodigoReduzidoCR := pCodReduzCre;

       if ( pCodigoReduzidoCR = 0)  then begin   //não pode ser zero
          raise Exception.Create('Erro ao obter o código reduzido.  '  + tempLancamentoCR.Complemento );
       end;

       if not obterContaMegaPorCodigo(pCodEmpresa,pCodigoReduzidoCR)  then begin

          raise Exception.Create('Erro ao obter o código reduzido. ' + tempLancamentoCR.Complemento );

       end else begin

        tempLancamentoCR.SetCodReduzCre(pCodigoReduzidoCR);

        tempLancamentoCR.SetDgCodReduzCre(qryExistCODREDUZ.FieldByName('DGREDUZ').AsString);
        tempLancamentoCR.SetContaCredito(qryExistCODREDUZ.FieldByName('CONTA').AsString);
        tempLancamentoCR.SetDgContaCredito(qryExistCODREDUZ.FieldByName('DGVER').AsString);

       end;   
       


     Result := tempLancamentoCR;

end;


function TdmExportaFinance.convertoTPB_PROVToLancamentoDebito(pCodEmpresa, pLote, pAno,  pCodReduzDeb,pCodHist: Integer; pHistorico,
                                                              pComple, pDgCodReduzDeb, pContaDeb, pDgDeb,  pTipo,pIdFinance, pIdentFnc: string; pValor: Currency; pData: TDateTime) : TLancamentoDebitoModel;
var
 tempLancamentoDB : TLancamentoDebitoModel;
 pCodigoReduzidoDB :Integer;
begin
pCodigoReduzidoDB :=0;

  tempLancamentoDB := TLancamentoDebitoModel.Create;
                      tempLancamentoDB.SetAno(IntToStr(pAno));
                      tempLancamentoDB.SetLote(pLote);
                      tempLancamentoDB.SetIdEmpresa(pCodEmpresa);
                      tempLancamentoDB.SetFilial(0);
                      tempLancamentoDB.SetCentroCusto(0);
                      tempLancamentoDB.SetDataLanc(uUtil.getDataServer);
                      tempLancamentoDB.SetValor(pValor);
                      tempLancamentoDB.SetData(pData);
                      tempLancamentoDB.SetCodHistorico(pCodHist);
                      tempLancamentoDB.SetComplemento(pComple);
                      tempLancamentoDB.SetHistorico(pHistorico);
                      tempLancamentoDB.SetIdRegistroFinance(pIdFinance);
                      tempLancamentoDB.SetFncIdentificacao(pIdentFnc);
                      tempLancamentoDB.SetTipo('1');   //1 - DEBITO  - 2 - CREDITO
                      tempLancamentoDB.SetExecTrigger('S'); //S sempre
                              
                    {  tempLancamentoDB.SetContaDebito(pContaDeb);
                      tempLancamentoDB.SetDgContaDebito(pDgDeb);
                      tempLancamentoDB.SetDgCodReduzDeb(pDgCodReduzDeb); 
                      tempLancamentoDB.SetCodReduzDeb(pCodReduzDeb);     }



        
       pCodigoReduzidoDB := pCodReduzDeb;

       if ( pCodigoReduzidoDB = 0)  then begin   //não pode ser zero
          raise Exception.Create('Erro ao obter o código reduzido.  '  + tempLancamentoDB.Complemento );
       end;

       if not obterContaMegaPorCodigo(pCodEmpresa,pCodigoReduzidoDB)  then begin

          raise Exception.Create('Erro ao obter o código reduzido. ' + tempLancamentoDB.Complemento );

       end else begin

        tempLancamentoDB.SetCodReduzDeb(pCodigoReduzidoDB);

        tempLancamentoDB.SetDgCodReduzDeb(qryExistCODREDUZ.FieldByName('DGREDUZ').AsString);
        tempLancamentoDB.SetContaDebito(qryExistCODREDUZ.FieldByName('CONTA').AsString);
        tempLancamentoDB.SetDgContaDebito(qryExistCODREDUZ.FieldByName('DGVER').AsString);

       end;   

                     


     Result := tempLancamentoDB;

end;





 function TdmExportaFinance.obterTPBDE(pIdOrganizacao, pIdTPB : String): Boolean;
begin

  Result := false;
  dmConexao.conectarBanco;

 try
        qryTPBDeducao.Close;
        qryTPBDeducao.Connection := dmConexao.Conn;
        qryTPBDeducao.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
        qryTPBDeducao.ParamByName('pIdTitutloPagarBaixa').AsString :=
          pIdTPB;
        qryTPBDeducao.Open;

   except
        raise(Exception).Create('Problemas ao OBTER DEDUÇÕES');
  end;

  Result := not qryTPBDeducao.IsEmpty;
end;

function TdmExportaFinance.obterTPBCAIXA(pIdOrganizacao, pIdTPB : String): Boolean;
begin

  Result := false;
  dmConexao.conectarBanco;

 try

      qryTPBCaixa.Close;
       qryTPBCaixa.Connection := dmConexao.Conn;
      qryTPBCaixa.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
      qryTPBCaixa.ParamByName('PIDTITULOPAGARBAIXA').AsString :=
        pIdTPB;
      qryTPBCaixa.Open;
  except
        raise(Exception).Create('Problemas ao OBTER TPB CX');
  end;

  Result := not qryTPBCaixa.IsEmpty;
end;


function TdmExportaFinance.obterTPBCHEQUE(pIdOrganizacao, pIdTPB : String): Boolean;
begin

  Result := false;
  dmConexao.conectarBanco;

    try

        qryTPBCheque.Close;
        qryTPBCheque.Connection := dmConexao.Conn;
        qryTPBCheque.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryTPBCheque.ParamByName('PIDTITULOPAGARBAIXA').AsString :=  pIdTPB;
        qryTPBCheque.Open;

      except
        raise(Exception).Create('Problemas ao OBTER TPB CHEQUE');
      end;


  Result := not qryTPBCheque.IsEmpty;
end;


function TdmExportaFinance.obterTPBINTERNET(pIdOrganizacao, pIdTPB : String): Boolean;
begin
  Result := false;
  dmConexao.conectarBanco;

    try

        qryTPBInternet.Close;
        qryTPBInternet.Connection := dmConexao.Conn;
        qryTPBInternet.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryTPBInternet.ParamByName('PIDTITULOPAGARBAIXA').AsString :=  pIdTPB;
        qryTPBInternet.Open;

      except
        raise(Exception).Create('Problemas ao OBTER TPB WWW ');
      end;

  Result := not qryTPBInternet.IsEmpty;
end;

//PEGA A SOMA DO VALOR_NOMINAL DE TODOS OS TITULOS A RECEBER QUITADOS
function TdmExportaFinance.obterValorDebitoTRB(pIdOrganizacao, pTable, pCampoSum, pCampoData: string;
                                                pDataInicial, pDataFinal: TDate;isProvisao :Integer ): Currency;
  var
  comando : string;
begin
dmConexao.conectarBanco;

comando := ' SELECT SUM(TR.VALOR_NOMINAL) AS VALOR_DEBITO  FROM  TITULO_RECEBER TR ' +
           ' WHERE (TR.DATA_PAGAMENTO  BETWEEN :DTDATAINICIAL AND :DTDATAFINAL )' +
           ' AND (TR.ID_ORGANIZACAO = :PIDORGANIZACAO)' +
           ' AND (TR.ID_TIPO_STATUS IN (''QUITADO'',''PARCIAL'') ) ' +
           ' AND (TR.ID_LOTE_CONTABIL IS null )' ;
        //consulta todos os titulos recebidos no periodo . organizacao e nao tenha sido exportado

    try
          qryObterValorTitulo.Close;
          qryObterValorTitulo.Connection := dmConexao.Conn;
          qryObterValorTitulo.SQL.Clear;
          qryObterValorTitulo.SQL.Add(comando);
          qryObterValorTitulo.ParamByName('PIDORGANIZACAO').AsString := PIDORGANIZACAO;
          qryObterValorTitulo.ParamByName('DTDATAINICIAL').AsDate := pDataInicial;
          qryObterValorTitulo.ParamByName('DTDATAFINAL').AsDate := pDataFinal;

          qryObterValorTitulo.Open;


      except
        raise(Exception).Create('Problemas ao OBTER VALOR DEBITO TRB');
      end;

       Result := qryObterValorTitulo.FieldByName('VALOR_DEBITO').AsCurrency;

end;

function TdmExportaFinance.preencheComboLoteContabil(pIdOrganizacao, pAno : string ) :boolean;
var
ano, cmd :string;
pDataInicial, pDataFinal, dataServer :TDateTime;

begin
  dataServer := uUtil.getDataServer;
  ano := FormatDateTime('yyyy', dataServer );
  pDataInicial := StrToDateTime('01/01/'+ano);

  Result := false;
  cmd :=  ' SELECT  LC.ID_LOTE_CONTABIL, LC.LOTE '+
          ' FROM LOTE_CONTABIL LC ' +
          ' WHERE (LC.ID_ORGANIZACAO = :PIDORGANIZACAO) AND ' +
          ' (LC.DATA_REGISTRO BETWEEN :DTDATAINICIAL AND :DTDATAFINAL) AND ' +
          ' LC.STATUS <> ''EXCLUIDO'' ' +
          ' ORDER BY LC.LOTE ' ;


  dmConexao.conectarBanco;

    try
        qryObterTodosLoteContabil.Close;
        qryObterTodosLoteContabil.Connection := dmConexao.Conn;
        qryObterTodosLoteContabil.SQL.Clear;
        qryObterTodosLoteContabil.SQL.Add(cmd);
        qryObterTodosLoteContabil.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryObterTodosLoteContabil.ParamByName('DTDATAINICIAL').AsDate := pDataInicial;
        qryObterTodosLoteContabil.ParamByName('DTDATAFINAL').AsDate := dataServer;
        qryObterTodosLoteContabil.Open;

      except
        raise(Exception).Create('Problemas ao OBTER LOTE CONTABIL');
      end;

    Result := not qryObterTodosLoteContabil.IsEmpty;

end;



function TdmExportaFinance.obterTPBHistorico(pIdorganizacao, tituloPagarQuitado :string): Boolean;
begin
  Result := false;
  dmConexao.conectarBanco;

  try
      qryTPBHistorico.Close;
      qryTPBHistorico.Connection := dmConexao.Conn;
      qryTPBHistorico.ParamByName('PIDTP').AsString := tituloPagarQuitado;
      qryTPBHistorico.ParamByName('PIDORGANIZACAO').AsString := pIdorganizacao;
      qryTPBHistorico.Open;
    except
        raise(Exception).Create('Problemas ao OBTER RATEIO HISTORICOS');
      end;


  Result := not qryTPBHistorico.IsEmpty;

end;

/// parte do TR //

function TdmExportaFinance.obterTRB(pIdOrganizacao, pAno: string; pDataInicial, pDataFinal: TDate; pCodEmpresa, pLote: Integer; var loMostraErros: TFMostraErros): TListaLancamentos;
var
aux :Integer;
begin
 try
          qryTRB.Close;
          qryTRB.Connection := dmConexao.Conn;
          qryTRB.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
          qryTRB.ParamByName('pDataInicial').AsDate := pDataInicial;
          qryTRB.ParamByName('pDataFinal').AsDate := pDataFinal;
          qryTRB.Open;
          qryTRB.Last;

       //convertendo para lista
          if not qryTRB.IsEmpty then
          begin
            FsListaLancamentos := convertTRBToMega('TRB',pIdOrganizacao, pAno, pCodEmpresa, pLote, qryTRB, loMostraErros);
          end;

  except
    raise(Exception).Create('Problemas ao tentar exportar TITULOS A RECEBER QUITADOS');

  end;

  Result := FsListaLancamentos;

end;


function TdmExportaFinance.obterTRBAC(pIdOrganizacao, pIdTRB: String): Boolean;
begin

  Result := false;
  dmConexao.conectarBanco;

 try
        qryTRBAcrescimos.Close;
        qryTRBAcrescimos.Connection := dmConexao.Conn;
        qryTRBAcrescimos.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryTRBAcrescimos.ParamByName('PIDTRB').AsString :=pIdTRB;
        qryTRBAcrescimos.Open;

   except
        raise(Exception).Create('Problemas ao OBTER ACRÉSCIMOS TRB');
  end;

  Result := not qryTRBAcrescimos.IsEmpty;

end;

function TdmExportaFinance.obterTRBHistorico(pIdorganizacao,
  tituloReceberQuitado: string): Boolean;
begin
 Result := false;
  dmConexao.conectarBanco;

  try
      qryTRBHistorico.Close;
      qryTRBHistorico.Connection := dmConexao.Conn;
      qryTRBHistorico.ParamByName('PIDTITULO').AsString := tituloReceberQuitado;
      qryTRBHistorico.ParamByName('PIDORGANIZACAO').AsString := pIdorganizacao;
      qryTRBHistorico.Open;
    except
        raise(Exception).Create('Problemas ao OBTER RATEIO HISTORICOS TRB');
      end;


  Result := not qryTRBHistorico.IsEmpty;


end;

function TdmExportaFinance.obterTRBINTERNET(pIdOrganizacao, pIdTR: String): Boolean;
begin

  Result := false;
  dmConexao.conectarBanco;

    try

        qryTRBInternet.Close;
        qryTRBInternet.Connection := dmConexao.Conn;
        qryTRBInternet.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryTRBInternet.ParamByName('PIDTR').AsString :=  pIdTR;
        qryTRBInternet.Open;

      except
        raise(Exception).Create('Problemas ao OBTER TRB WWW ');
      end;

  Result := not qryTRBInternet.IsEmpty;

end;

function TdmExportaFinance.obterTRBBAC(pIdOrganizacao, pIdTRB: String): Boolean;
begin
begin
dmConexao.conectarBanco;

  Result := false;
try
  qryTRBAcrescimos.Close;
  qryTRBAcrescimos.Connection := dmConexao.Conn;
  qryTRBAcrescimos.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
  qryTRBAcrescimos.ParamByName('PIDTRB').AsString :=  pIdTRB;
  qryTRBAcrescimos.Open;

except
        raise(Exception).Create('Problemas ao OBTER ACRÉSCIMOS TRB');
end;


  Result := not qryTRBAcrescimos.IsEmpty;
end;

end;


function TdmExportaFinance.obterTRBCAIXA(pIdOrganizacao, pIdTRB: String): Boolean;
begin
Result := false;
  dmConexao.conectarBanco;

 try
      qryTRBCaixa.Close;
       qryTRBCaixa.Connection := dmConexao.Conn;
      qryTRBCaixa.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
      qryTRBCaixa.ParamByName('PIDTRB').AsString :=  pIdTRB;
      qryTRBCaixa.Open;
  except
        raise(Exception).Create('Problemas ao OBTER TRB CX');
  end;

  Result := not qryTRBCaixa.IsEmpty;

end;

function TdmExportaFinance.obterTRBCHEQUE(pIdOrganizacao, pIdTRB: String): Boolean;
begin
  Result := false;
  dmConexao.conectarBanco;

    try

        qryTRBCheque.Close;
        qryTRBCheque.Connection := dmConexao.Conn;
        qryTRBCheque.ParamByName('PIDORGANIZACAO').AsString := pIdOrganizacao;
        qryTRBCheque.ParamByName('PIDTRB').AsString :=  pIdTRB;
        qryTRBCheque.Open;

      except
        raise(Exception).Create('Problemas ao OBTER TRB CHEQUE');
      end;


  Result := not qryTRBCheque.IsEmpty;


end;

function TdmExportaFinance.obterTRBDE(pIdOrganizacao, pIdTRB: String): Boolean;
begin

  Result := false;
  dmConexao.conectarBanco;

 try
        qryTRBDeducao.Close;
        qryTRBDeducao.Connection := dmConexao.Conn;
        qryTRBDeducao.ParamByName('pIdOrganizacao').AsString := pIdOrganizacao;
        qryTRBDeducao.ParamByName('PIDTRB').AsString :=pIdTRB;
        qryTRBDeducao.Open;

   except
        raise(Exception).Create('Problemas ao OBTER DEDUÇÕES TRB');
  end;

  Result := not qryTRBDeducao.IsEmpty;


end;

function TdmExportaFinance.convertTRBToMega(pTipoTitulo,pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery; var loMostraErros: TFMostraErros): TListaLancamentos;
var
    qtdParcelas, aux: Integer;
    tempLancamentoCR: TLancamentoCreditoModel;
    tempLancamentoDB: TLancamentoDebitoModel;

pIDBAIXA, pRegistroProvisao, pID, pID_ORG, cmd :string;
  VALOR: Currency; fData: TDate;
   CDHIST,CDREDUZDEB, CDREDUZCRE: Integer;
  IDENTIFCRE, ID,HISTORICO, COMPL,DGREDUZCRE, DGCRE,CONTA_CRE :string;
 auxCD, IDENTIFDEB, DGREDUZDEB ,DGDEB, CONTA_DEB, nDOC :string;

 auxValorTP, auxValorBaixa, auxValorDB :Currency;

  // query contem os titulos pagos/recebidos
  // analisar primeiro o titulo que foi provisionado e está pago
  // se provisionado e pago. .a conta credito fica na parte do pagamento e debito é fornecedor

begin
  try
    FsListaLancamentos := TListaLancamentos.Create;
    FsListaCredito := TListaLancamentoCredito.Create;
    FsListaDebito := TListaLancamentoDebito.Create;

    query.First; //contem alguns dados do TITULO
    //precisa consultar os creditos e debitos
    while (not query.Eof) do
       begin
             pID               := query.FieldByName('ID').AsString;
             nDoc              := query.FieldByName('NUMERO_DOCUMENTO').AsString;
             pIDBAIXA          := query.FieldByName('IDTRB').AsString;
             pID_ORG           := query.FieldByName('ID_ORGANIZACAO').AsString;
            // qtdParcelas       := query.FieldByName('QTD').AsInteger;
             fData             := query.FieldByName('DATA_PAGAMENTO').AsDateTime;
             pRegistroProvisao := query.FieldByName('REGISTRO_PROVISAO').AsString;
             IDENTIFCRE        := query.FieldByName('NUMERO_DOCUMENTO').AsString;
             IDENTIFDEB        := query.FieldByName('NUMERO_DOCUMENTO').AsString;



       try
              if not Uutil.Empty(pRegistroProvisao) then begin // se tem registro provisao indica que o TP foi provisinando
                //conta debito = ID_conta_contabil_credito do TP (Fornecedor)

                     VALOR       := query.FieldByName('VALOR').AsCurrency;
                     ID          := query.FieldByName('ID').AsString;

                     HISTORICO   := query.FieldByName('HISTORICO').AsString;
                     CDHIST      := query.FieldByName('CDHIST').AsInteger;
                     COMPL       := query.FieldByName('COMPL').AsString;

                     CDREDUZCRE  := query.FieldByName('CDREDUZCRE').AsInteger;
                     DGREDUZCRE  := query.FieldByName('DGREDUZCRE').AsString;
                     DGCRE       := query.FieldByName('DGCRE').AsString;
                     CONTA_CRE   := query.FieldByName('CONTA_CRE').AsString;

//                      loMostraErros.Add('VALOR PROVISAO  ' +  nDOC + ' VALOR PROV ' +  FormatCurr('###,##0.00', VALOR) );


                     FsListaCredito.Adicionar(convertoTITULOinLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));

              end  // fim da parte contabil tr prov
              else begin
          //se nao for provisionado, a cointa debito está no rateio de historicos
                if obterTRBHistorico(pID_ORG,pID) then begin
                  //obtendo o rateio de historicos e suas contas contabeis

                   while not qryTRBHistorico.Eof do begin


                       VALOR       := qryTRBHistorico.FieldByName('VALOR').AsCurrency;
                       ID          := query.FieldByName('ID').AsString;

                       HISTORICO   := qryTRBHistorico.FieldByName('HISTORICO').AsString;
                       CDHIST      := qryTRBHistorico.FieldByName('CDHIST').AsInteger;
                       COMPL       := 'DOC '+ nDoc + ' ' + qryTRBHistorico.FieldByName('COMPL').AsString;

                     CDREDUZCRE  := qryTRBHistorico.FieldByName('CDREDUZCRE').AsInteger;
                     DGREDUZCRE  := qryTRBHistorico.FieldByName('DGREDUZCRE').AsString;
                     DGCRE       := qryTRBHistorico.FieldByName('DGCRE').AsString;
                     CONTA_CRE   := qryTRBHistorico.FieldByName('CONTA_CRE').AsString;

                     if VALOR = 0 then begin

                      loMostraErros.Add('#### ' + 'TR  ' + nDOC  + ' ID TR ' + pID  );
                      loMostraErros.Add('BAIXA TR ' +  nDOC + ' VALOR TR ' +  FormatCurr('###,##0.00',query.FieldByName('VALOR').AsCurrency) );

                      loMostraErros.Add('HISTORICO  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );
                     end else begin


                      FsListaCredito.Adicionar(convertoTITULOinLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));
                     end;

                      qryTRBHistorico.Next;

                   end;

                end;
              end;


              try
                // VERIFICAR SE EXISTEM LANCAMENTOS EM ACRESCIMOS
                //

                 if (obterTRBAC(pID_ORG,pIDBAIXA)) then begin

                  //existem acrescimos  do TP

                  while not qryTRBAcrescimos.Eof do
                      begin

                           VALOR       := qryTRBAcrescimos.FieldByName('VALOR').AsCurrency;
                           ID          := query.FieldByName('ID').AsString;
                           HISTORICO   := qryTRBAcrescimos.FieldByName('HISTORICO').AsString;
                           CDHIST      := qryTRBAcrescimos.FieldByName('CDHIST').AsInteger;

                          COMPL       := 'DOC '+ nDoc + ' ' +  qryTRBAcrescimos.FieldByName('COMPL').AsString;

                           CDREDUZCRE  := qryTRBAcrescimos.FieldByName('CDREDUZCRE').AsInteger;
                           DGREDUZCRE  := qryTRBAcrescimos.FieldByName('DGREDUZCRE').AsString;
                           DGCRE       := qryTRBAcrescimos.FieldByName('DGCRE').AsString;
                           CONTA_CRE   := qryTRBAcrescimos.FieldByName('CONTA_CRE').AsString;

                           loMostraErros.Add('ACRESCIMOS  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                            FsListaCredito.Adicionar(convertoTITULOinLancamentoCredito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                           CDREDUZCRE,CDHIST,HISTORICO,COMPL,
                                                                           DGREDUZCRE,CONTA_CRE,DGCRE,'2',ID,IDENTIFCRE,VALOR,fData));



                          qryTRBAcrescimos.Next;
                       end;
                end;

             except
              raise(Exception).Create('Problemas ao obter dados dos acréscimos');
             end;


             try
                 // obtendo as DEDUÇÕES
                  if (obterTRBDE(pID_ORG,pIDBAIXA)) then begin
                   //pegando as deducoes
                      while not qryTRBDeducao.Eof do begin

                          VALOR       := qryTRBDeducao.FieldByName('VALOR').AsCurrency;
                          ID          := query.FieldByName('ID').AsString;
                          HISTORICO   := qryTRBDeducao.FieldByName('HISTORICO').AsString;
                          COMPL       := 'DOC '+ nDoc + ' ' +  qryTRBDeducao.FieldByName('COMPL').AsString;
                          CDHIST      := qryTRBDeducao.FieldByName('CDHIST').AsInteger;

                          CDREDUZDEB  := qryTRBDeducao.FieldByName('CDREDUZDEB').AsInteger;
                          DGREDUZDEB  := qryTRBDeducao.FieldByName('DGREDUZDEB').AsString;
                          DGDEB       := qryTRBDeducao.FieldByName('DGDEB').AsString;
                          CONTA_DEB   := qryTRBDeducao.FieldByName('CONTA_DEB').AsString;


                           loMostraErros.Add('DEDUÇÃO  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                           FsListaDebito.Adicionar( convertoTITULOinLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                               CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                               DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));




                          qryTRBDeducao.Next;

                      end;
                  end;
             except
              raise(Exception).Create('Problemas ao obter dados das deduções ');
             end;

             try
                  //OBTER FORMA DE PAGAMENTO CAIXA
                    if (obterTRBCAIXA(pID_ORG,pIDBAIXA)) then begin
                   //pegando as deducoes
                      while not qryTRBCaixa.Eof do begin

                          VALOR       := qryTRBCaixa.FieldByName('VALOR').AsCurrency;
                          ID          := query.FieldByName('ID').AsString;
                          HISTORICO   := qryTRBCaixa.FieldByName('HISTORICO').AsString;
                         COMPL       := 'DOC '+ nDoc + ' ' +  qryTRBCaixa.FieldByName('COMPL').AsString;
                          CDHIST      := qryTRBCaixa.FieldByName('CDHIST').AsInteger;

                          CDREDUZDEB  := qryTRBCaixa.FieldByName('CDREDUZDEB').AsInteger;
                          DGREDUZDEB  := qryTRBCaixa.FieldByName('DGREDUZDEB').AsString;
                          DGDEB       := qryTRBCaixa.FieldByName('DGDEB').AsString;
                          CONTA_DEB   := qryTRBCaixa.FieldByName('CONTA_DEB').AsString;

                           auxValorTP := query.FieldByName('VALOR').AsCurrency;

                           if auxValorTP <> VALOR then begin
                            loMostraErros.Add('#### ' + 'TR  ' + nDOC  + ' ID TR ' + pID  );
                            loMostraErros.Add('BAIXA TR ' +  nDOC + ' VALOR TR ' +  FormatCurr('###,##0.00',query.FieldByName('VALOR').AsCurrency) );

                                loMostraErros.Add(' DIFERENCA DE VALOR CAIXA  DOC ' +  nDOC + '  VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                           end;



                            if VALOR = 0 then begin
                               loMostraErros.Add('CAIXA  ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );
                            end else begin

                             FsListaDebito.Adicionar( convertoTITULOinLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                               CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                               DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));
                            end;


                          qryTRBCaixa.Next;

                      end;
                  end;


             except
              raise(Exception).Create('Problemas ao obter dados do credito/baixa por tesouraria ');
             end;
                 try
                   //OBTER FORMA DE PAGAMENTO EM CHERQUE
                    if (obterTRBCHEQUE(pID_ORG,pIDBAIXA)) then begin
                   //pegando as deducoes
                      while not qryTRBCheque.Eof do begin

                          VALOR       := qryTRBCheque.FieldByName('VALOR').AsCurrency;
                          ID          := query.FieldByName('ID').AsString;
                          HISTORICO   := qryTRBCheque.FieldByName('HISTORICO').AsString;
                         COMPL       := 'DOC '+ nDoc + ' ' +  qryTRBCheque.FieldByName('COMPL').AsString;
                          CDHIST      := qryTRBCheque.FieldByName('CDHIST').AsInteger;

                          CDREDUZDEB  := qryTRBCheque.FieldByName('CDREDUZDEB').AsInteger;
                          DGREDUZDEB  := qryTRBCheque.FieldByName('DGREDUZDEB').AsString;
                          DGDEB       := qryTRBCheque.FieldByName('DGDEB').AsString;
                          CONTA_DEB   := qryTRBCheque.FieldByName('CONTA_DEB').AsString;


                           auxValorTP := query.FieldByName('VALOR').AsCurrency;

                           if auxValorTP <> VALOR then begin
                               loMostraErros.Add('#### ' + 'TR  ' + nDOC  + ' ID TR ' + pID  );
                               loMostraErros.Add('BAIXA TR ' +  nDOC + ' VALOR TR ' +  FormatCurr('###,##0.00',query.FieldByName('VALOR').AsCurrency) );

                                loMostraErros.Add(' DIFERENCA DE VALOR CH   DOC ' +  nDOC + '  VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                           end;



                            if VALOR = 0 then begin
                               loMostraErros.Add('CHEQUE   ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );
                            end else begin

                              FsListaDebito.Adicionar( convertoTITULOinLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                               CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                               DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));
                            end;

                          qryTRBCheque.Next;
                      end;
                  end;
             except
              raise(Exception).Create('Problemas ao obter dados da baixa por cheque');
             end;
                  try
                     //OBTER FORMA DE PAGAMENTO EM INTERNET
                    if (obterTRBINTERNET(pID_ORG,pID)) then begin

                      while not qryTRBInternet.Eof do begin

                          VALOR       := qryTRBInternet.FieldByName('VALOR').AsCurrency;
                          ID          := query.FieldByName('ID').AsString;
                          //nesse caso os dados abaixo vem de TOB
                          HISTORICO   := qryTRBInternet.FieldByName('HISTORICO').AsString;
                          COMPL       := 'DOC '+ nDoc + ' ' +  qryTRBInternet.FieldByName('COMPL').AsString;
                          CDHIST      := qryTRBInternet.FieldByName('CDHIST').AsInteger;

                          CDREDUZDEB  := qryTRBInternet.FieldByName('CDREDUZDEB').AsInteger;
                          DGREDUZDEB  := qryTRBInternet.FieldByName('DGREDUZDEB').AsString;
                          DGDEB       := qryTRBInternet.FieldByName('DGDEB').AsString;
                          CONTA_DEB   := qryTRBInternet.FieldByName('CONTA_DEB').AsString;



                           auxValorTP := query.FieldByName('VALOR').AsCurrency;

                           if auxValorTP <> VALOR then begin

                             loMostraErros.Add('#### ' + 'TR  ' + nDOC  + ' ID TR ' + pID  );
                             loMostraErros.Add('BAIXA TR ' +  nDOC + ' VALOR TR ' +  FormatCurr('###,##0.00',query.FieldByName('VALOR').AsCurrency) );

                                loMostraErros.Add(' DIFERENCA DE VALOR WWW  DOC ' +  nDOC + '  VALOR ' +  FormatCurr('###,##0.00', VALOR) );

                           end;



                            if VALOR = 0 then begin
                               loMostraErros.Add('PAGTO ONLINE   ' +  HISTORICO + ' VALOR ' +  FormatCurr('###,##0.00', VALOR) );
                            end else begin

                            FsListaDebito.Adicionar( convertoTITULOinLancamentoDebito(pCodEmpresa,pLote,StrToInt(pAno),
                                                                               CDREDUZDEB,CDHIST,HISTORICO,COMPL,
                                                                               DGREDUZDEB,CONTA_DEB,DGDEB,'1',ID,IDENTIFDEB,VALOR,fData));
                            end;


                          qryTRBInternet.Next;

                      end;
                  end;
             except
              raise(Exception).Create('Problemas ao obter dados da baixa internet');
             end;

             except
              raise(Exception).Create('Problemas ao obter dados da baixa');
             end;

      query.Next;
    end;

    FsListaLancamentos.AdicionarCredito(FsListaCredito);
    FsListaLancamentos.AdicionarDebito(FsListaDebito);

  except
    raise(Exception).Create('Problemas ao converter lancamentos.');
//    on E: Exception do
//    E.Message ;
  end;

  //validar as duas listas
  //1- garantir que o valor de credito e de debito sao iguais
  //2- garantir que a conta contabil exista no MEGA
  //3- garantir que a conta reduzida exista no MEGA
  // validarLancamentos(pIdOrganizacao, FsListaLancamentos, pCodEmpresa);

  Result := FsListaLancamentos;

end;


//generico


function TdmExportaFinance.convertoTITULOinLancamentoDebito(pCodEmpresa, pLote, pAno,  pCodReduzDeb,pCodHist: Integer; pHistorico,
                                                              pComple, pDgCodReduzDeb, pContaDeb, pDgDeb,  pTipo,pIdFinance, pIdentFnc: string; pValor: Currency; pData: TDateTime) : TLancamentoDebitoModel;
var
 tempLancamentoDB : TLancamentoDebitoModel;
begin

  tempLancamentoDB := TLancamentoDebitoModel.Create;
                      tempLancamentoDB.SetAno(IntToStr(pAno));
                      tempLancamentoDB.SetLote(pLote);
                      tempLancamentoDB.SetIdEmpresa(pCodEmpresa);
                      tempLancamentoDB.SetFilial(0);
                      tempLancamentoDB.SetCentroCusto(0);
                      tempLancamentoDB.SetDataLanc(uUtil.getDataServer);
                      tempLancamentoDB.SetValor(pValor);
                      tempLancamentoDB.SetData(pData);
                      tempLancamentoDB.SetContaDebito(pContaDeb);
                      tempLancamentoDB.SetDgContaDebito(pDgDeb);
                      tempLancamentoDB.SetCodReduzDeb(pCodReduzDeb);
                      tempLancamentoDB.SetDgCodReduzDeb(pDgCodReduzDeb);
                      tempLancamentoDB.SetCodHistorico(pCodHist);
                      tempLancamentoDB.SetComplemento(pComple);
                      tempLancamentoDB.SetHistorico(pHistorico);
                      tempLancamentoDB.SetIdRegistroFinance(pIdFinance);
                      tempLancamentoDB.SetFncIdentificacao(pIdentFnc);
                      tempLancamentoDB.SetTipo('1');   //1 - DEBITO  - 2 - CREDITO
                      tempLancamentoDB.SetExecTrigger('S'); //S sempre


     Result := tempLancamentoDB;

end;


function TdmExportaFinance.convertoTITULOinLancamentoCredito(pCodEmpresa, pLote, pAno, pCodReduzCre,pCodHist: Integer; pHistorico, pComple, pDgCodReduzCre, pContaCre, pDgCre,  pTipo,pIdFinance, pIdentFnc: string; pValor: Currency; pData: TDateTime) : TLancamentoCreditoModel;
var
 tempLancamentoCR : TLancamentoCreditoModel;
begin
      tempLancamentoCR := TLancamentoCreditoModel.Create;
                          tempLancamentoCR.SetAno(IntToStr(pAno));
                          tempLancamentoCR.SetLote(pLote);
                          tempLancamentoCR.SetIdEmpresa(pCodEmpresa);
                          tempLancamentoCR.SetFilial(0);
                          tempLancamentoCR.SetCentroCusto(0);
                          tempLancamentoCR.SetDataLanc(uUtil.getDataServer);
                          tempLancamentoCR.SetValor(pValor);
                          tempLancamentoCR.SetData(pData);
                          tempLancamentoCR.SetContaCredito(pContaCre) ;
                          tempLancamentoCR.SetDgContaCredito(pDgCre);
                          tempLancamentoCR.SetCodReduzCre(pCodReduzCre);
                          tempLancamentoCR.SetDgCodReduzCre(pDgCodReduzCre);
                          tempLancamentoCR.SetCodHistorico(pCodHist);
                          tempLancamentoCR.SetComplemento(pComple);
                          tempLancamentoCR.SetHistorico(pHistorico);
                          tempLancamentoCR.SetIdRegistroFinance(pIdFinance);
                          tempLancamentoCR.SetRegistroProvisao('0');
                          tempLancamentoCR.SetFncIdentificacao(pIdentFnc);
                          tempLancamentoCR.SetTipo('2');  //1 - DEBITO  - 2 - CREDITO
                          tempLancamentoCR.SetExecTrigger('S'); //S sempre


     Result := tempLancamentoCR;

end;


function TdmExportaFinance.convertTRPROVToLancamentoMega(pTipoTitulo,pIdOrganizacao, pAno: string; pCodEmpresa, pLote: Integer; query: TFDQuery; var loMostraErros: TFMostraErros): TListaLancamentos;
var
 qtdParcelas, aux: Integer;
  tempLancamentoCR: TLancamentoCreditoModel;
  tempLancamentoDB: TLancamentoDebitoModel;
//  loMostraErros: TFMostraErros;
 pRegistroProvisao, pID, pID_ORG, cmd :string;
  //campos necessarios para preencher o credito
  VALOR: Currency; fData: TDate;
   CDHIST,CDREDUZDEB, CDREDUZCRE: Integer;
  IDENTIFCRE, ID,HISTORICO, COMPL,DGREDUZCRE, DGCRE,CONTA_CRE :string;
  IDENTIFDEB, DGREDUZDEB ,DGDEB, CONTA_DEB :string;

  // query contem os titulos pagos/recebidos que foram provisionados apenas
  // no caso do TITULO A PAGAR
  // a consulta deve trazer todos os titulos pagos ou nao
  // conta credito fica no cedente
  //conta debito fica no rateio de historicos (tabela titulo_pagar_historico)


begin

  try
    FsListaLancamentos := TListaLancamentos.Create;
    FsListaCredito := TListaLancamentoCredito.Create;
    FsListaDebito := TListaLancamentoDebito.Create;


    query.First; //contem alguns dados do TITULO
    //precisa consultar os creditos e debitos
    while (not query.Eof) do
       begin
             pID               := query.FieldByName('ID').AsString;
             pID_ORG           := query.FieldByName('ID_ORGANIZACAO').AsString;
           //  qtdParcelas       := query.FieldByName('QTD').AsInteger;
             fData             := query.FieldByName('DATA_EMISSAO').AsDateTime;
             pRegistroProvisao := query.FieldByName('REGISTRO_PROVISAO').AsString;

          if(pTipoTitulo.Equals('TR')) then begin

            try
                qryTRCR.Close;
                qryTRCR.Connection := dmConexao.Conn;
                qryTRCR.ParamByName('PIDORGANIZACAO').AsString := pID_ORG;
                qryTRCR.ParamByName('pID').AsString := pID;
                qryTRCR.Open;

                if not qryTRCR.IsEmpty then begin

                   qryTRCR.First;
                   while not qryTRCR.Eof do
                   begin
                         //preencher as variaveis aqui

                          VALOR       := qryTRCR.FieldByName('VALOR').AsCurrency;  // (qtdParcelas * (qryTPPROVCR.FieldByName('VALOR').AsCurrency));

                          CDREDUZDEB  :=0;
                          IF  NOT (qryTRCR.FieldByName('CDREDUZDEB').AsString = string.Empty ) then begin
                              CDREDUZDEB  := StrToInt(qryTRCR.FieldByName('CDREDUZDEB').AsString);
                          end;

                          IDENTIFCRE  := qryTRCR.FieldByName('IDENTIFCRE').AsString;
                          ID          := qryTRCR.FieldByName('ID').AsString;
                          HISTORICO   := qryTRCR.FieldByName('HISTORICO').AsString;
                          COMPL       := qryTRCR.FieldByName('COMPL').AsString;
                          CDHIST      := qryTRCR.FieldByName('CDHIST').AsInteger;
                          DGREDUZDEB  := qryTRCR.FieldByName('DGREDUZDEB').AsString;
                          DGDEB       := qryTRCR.FieldByName('DGDEB').AsString;
                          CONTA_DEB   := qryTRCR.FieldByName('CONTA_DEB').AsString;

                          IDENTIFDEB  := IDENTIFCRE;

                          tempLancamentoDB := TLancamentoDebitoModel.Create;
                          tempLancamentoDB.SetAno(pAno);
                          tempLancamentoDB.SetLote(pLote);
                          tempLancamentoDB.SetIdEmpresa(pCodEmpresa);
                          tempLancamentoDB.SetFilial(0);
                          tempLancamentoDB.SetCentroCusto(0);
                          tempLancamentoDB.SetDataLanc(uUtil.getDataServer);
                          tempLancamentoDB.SetValor(VALOR);
                          tempLancamentoDB.SetData(fData);
                          tempLancamentoDB.SetContaDebito(CONTA_DEB);
                          tempLancamentoDB.SetDgContaDebito(DGDEB);
                          tempLancamentoDB.SetCodReduzDeb(CDREDUZDEB);
                          tempLancamentoDB.SetDgCodReduzDeb(DGREDUZDEB);
                          tempLancamentoDB.SetCodHistorico(CDHIST);
                          tempLancamentoDB.SetComplemento(COMPL);
                          tempLancamentoDB.SetHistorico(HISTORICO);
                          tempLancamentoDB.SetIdRegistroFinance(ID);
                          tempLancamentoDB.SetRegistroProvisao(pRegistroProvisao);
                          tempLancamentoDB.SetFncIdentificacao(IDENTIFDEB);
                          tempLancamentoDB.SetTipo('1');   //1 - DEBITO  - 2 - CREDITO
                          tempLancamentoDB.SetExecTrigger('S'); //S sempre

                        FsListaDebito.Adicionar(tempLancamentoDB);



                    qryTRCR.Next;
                   end;
                end;
             except
              raise(Exception).Create('Problemas ao consultar débitos do TR.  ' + pID);
             end;
          end;
         //obtendo os creditos


    //linha do debito

              try
                qryTRDB.Close;
                qryTRDB.Connection := dmConexao.Conn;
                qryTRDB.ParamByName('PIDORGANIZACAO').AsString := pID_ORG;
                qryTRDB.ParamByName('pID').AsString := pID;
                qryTRDB.Open;

              except

              raise(Exception).Create('Problemas ao consultar débitos do TP.');

              end;

         if not qryTRDB.IsEmpty then begin

            qryTRDB.First;
            while not qryTRDB.Eof do
            begin

                           VALOR       := qryTRDB.FieldByName('VALOR').AsCurrency; //(qtdParcelas * (qryTPPROVDB.FieldByName('VALOR').AsCurrency));
                           ID          := qryTRDB.FieldByName('ID').AsString;
                           HISTORICO   := qryTRDB.FieldByName('HISTORICO').AsString;
                           COMPL       := qryTRDB.FieldByName('COMPL').AsString;
                           CDHIST      := qryTRDB.FieldByName('CDHIST').AsInteger;

                          DGREDUZCRE  := qryTRDB.FieldByName('DGREDUZCRE').AsString;
                          CDREDUZCRE  := qryTRDB.FieldByName('CDREDUZCRE').AsInteger;
                          DGCRE       := qryTRDB.FieldByName('DGCRE').AsString;
                          CONTA_CRE   := qryTRDB.FieldByName('CONTA_CRE').AsString;


                          tempLancamentoCR := TLancamentoCreditoModel.Create;
                          tempLancamentoCR.SetAno(pAno);
                          tempLancamentoCR.SetLote(pLote);
                          tempLancamentoCR.SetIdEmpresa(pCodEmpresa);
                          tempLancamentoCR.SetFilial(0);
                          tempLancamentoCR.SetCentroCusto(0);
                          tempLancamentoCR.SetDataLanc(uUtil.getDataServer);
                          tempLancamentoCR.SetValor(VALOR);
                          tempLancamentoCR.SetData(fData);
                          tempLancamentoCR.SetContaCredito(CONTA_CRE) ;
                          tempLancamentoCR.SetDgContaCredito(DGCRE);
                          tempLancamentoCR.SetCodReduzCre(CDREDUZCRE);
                          tempLancamentoCR.SetDgCodReduzCre(DGREDUZCRE);
                          tempLancamentoCR.SetCodHistorico(CDHIST);
                          tempLancamentoCR.SetComplemento(COMPL);
                          tempLancamentoCR.SetHistorico(HISTORICO);
                          tempLancamentoCR.SetIdRegistroFinance(ID);
                          tempLancamentoCR.SetRegistroProvisao(pRegistroProvisao);
                          tempLancamentoCR.SetFncIdentificacao(IDENTIFCRE);
                          tempLancamentoCR.SetTipo('2');  //1 - DEBITO  - 2 - CREDITO
                          tempLancamentoCR.SetExecTrigger('S'); //S sempre

                      FsListaCredito.Adicionar(tempLancamentoCR);

              qryTRDB.Next;
            end;

         end;

      query.Next;
    end;

    FsListaLancamentos.AdicionarCredito(FsListaCredito);
    FsListaLancamentos.AdicionarDebito(FsListaDebito);

  except
    raise(Exception).Create('Problemas ao converter lancamentos.');
//    on E: Exception do
//    E.Message ;
  end;

  //validar as duas listas
  //1- garantir que o valor de credito e de debito sao iguais
  //2- garantir que a conta contabil exista no MEGA
  //3- garantir que a conta reduzida exista no MEGA
   validarLancamentos(pIdOrganizacao, FsListaLancamentos, pCodEmpresa);

  Result := FsListaLancamentos;

end;







end.


