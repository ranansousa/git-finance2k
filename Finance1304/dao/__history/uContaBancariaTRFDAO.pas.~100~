unit uContaBancariaTRFDAO;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, FireDAC.Stan.Intf, FireDAC.Stan.Option, MDDAO, MDModel,
  FireDAC.Stan.Param, FireDAC.Stan.Error, FireDAC.DatS, FireDAC.Phys.Intf,uOrganizacaoModel,
  uContaBancariaDBModel,uTipoOperacaoBancariaModel,uFuncionarioModel,uContaBancariaChequeModel,uLoteContabilModel,uUsuarioModel,
  uTipoOperacaoBancariaDAO,uFuncionarioDAO,uContaBancariaChequeDAO,uLoteContabilDAO,uUsuarioDAO,
  uContaBancariaCRModel, uContaBancariaDebitoDAO,uContaBancariaCreditoDAO, uContaBancariaTRFModel,
  FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB, uContaBancariaModel,uContaBancariaDAO, udmConexao, uUtil,
  FireDAC.Comp.DataSet, FireDAC.Comp.Client,
    Vcl.StdCtrls;


  const
   pTable : string = 'CONTA_BANCARIA_TRANSFERENCIA';

type
 TContaBancariaTRFDAO = class
  private
  class function getModel (query :TFDQuery) : TContaBancariaTRFModel;

  public

    class function Insert(value :TContaBancariaTRFModel): Boolean;
    class function obterPorID(value :TContaBancariaTRFModel): TContaBancariaTRFModel;
    class function Delete(value: TContaBancariaTRFModel): Boolean;
    class function Update(value: TContaBancariaTRFModel): Boolean;
    class function obterTodos(value: TContaBancariaTRFModel; pDataInicial, pDataFinal :TDateTime) : TFDQuery; overload;
    class function obterTodos(value: string; pDataInicial, pDataFinal :TDateTime; var combo: TComboBox; var listaID: TStringList): boolean; overload;

    class function transfereEntreContas (value : TContaBancariaTRFModel) :Boolean;
    class function estornarTransfEntreContas(value : TContaBancariaTRFModel) :Boolean;


  end;

implementation

{ TContaBancariaDebitoDAO }

class function TContaBancariaTRFDAO.Delete(value :TContaBancariaTRFModel): Boolean;
var
qryDelete : TFDQuery;
sucesso  :Boolean;
begin
  sucesso := False;
  dmConexao.conectarBanco;
  qryDelete := TFDQuery.Create(nil);

  try
    try

      qryDelete.Close;
      qryDelete.Connection := dmConexao.conn;
      qryDelete.SQL.Clear;
      qryDelete.SQL.Add('DELETE FROM CONTA_BANCARIA_TRANSFERENCIA  ');
      qryDelete.SQL.Add('WHERE ID_ORGANIZACAO = :PIDORGANIZACAO  AND  ID_CONTA_BANCARIA_TRANSFERENCIA = :PID ');
      qryDelete.ParamByName('PIDORGANIZACAO').AsString := value.FIDorganizacao;
      qryDelete.ParamByName('PID').AsString := value.FID;

      qryDelete.ExecSQL;

      if qryDelete.RowsAffected > 0 then
      begin
        sucesso := True;
      end;
    except
      sucesso := False;
      raise Exception.Create('Erro ao tentar DELETAR CBT');
    end;
    Result := sucesso;
  finally
    FreeAndNil(qryDelete);
  end;
end;


class function TContaBancariaTRFDAO.estornarTransfEntreContas(value: TContaBancariaTRFModel): Boolean;
var
 sucesso : Boolean;
begin
sucesso := False;

  if not dmConexao.conn.InTransaction then
    dmConexao.conn.StartTransaction;

    try

      if not uutil.Empty(value.FcontaBancariaDB.FID) then begin
       sucesso := TContaBancariaDebitoDAO.Delete(value.FcontaBancariaDB);
      end;

      if not uutil.Empty(value.FcontaBancariaCR.FID) then begin
       sucesso := TContaBancariaCreditoDAO.Delete(value.FcontaBancariaCR);
      end;

      if sucesso then begin

        Delete(value);

      end;


      if dmConexao.conn.InTransaction then
        dmConexao.conn.CommitRetaining;
    except
      if dmConexao.conn.InTransaction then
        dmConexao.conn.RollbackRetaining;

    end;

    Result := sucesso;

end;
class function TContaBancariaTRFDAO.getModel(  query: TFDQuery): TContaBancariaTRFModel;
var
 transf : TContaBancariaTRFModel;
 contaDB : TContaBancariaDBModel;
 contaCR : TContaBancariaCRModel;

begin
      transf  := TContaBancariaTRFModel.Create;
      contaDB := TContaBancariaDBModel.Create;
      contaCR := TContaBancariaCRModel.Create;
 try
  try
    if not query.IsEmpty then
    begin

      transf.FID                  := query.FieldByName('ID_CONTA_BANCARIA_TRANSFERENCIA').AsString;
      transf.FIDorganizacao       := query.FieldByName('ID_ORGANIZACAO').AsString;
      transf.FIDusuario           := query.FieldByName('ID_USUARIO').AsInteger;
      transf.FIDResponsavel       := query.FieldByName('ID_RESPONSAVEL').AsString;
      transf.FIDTOB               := query.FieldByName('ID_TIPO_OPERACAO_BANCARIA').AsString;
      transf.FIDcontaBancariaCR   := query.FieldByName('ID_CONTA_BANCARIA_CREDITO').AsString;
      transf.FIDcontaBancariaDB   := query.FieldByName('ID_CONTA_BANCARIA_DEBITO').AsString;
      transf.FIDloteContabil      := query.FieldByName('ID_LOTE_CONTABIL').AsString;
      transf.Fidentificacao       := query.FieldByName('IDENTIFICACAO').AsString;
      transf.Fobservacao          := query.FieldByName('OBSERVACAO').AsString;
      transf.Fvalor               := query.FieldByName('VALOR').AsCurrency;
      transf.FdataRegistro        := query.FieldByName('DATA_REGISTRO').AsDateTime;
      transf.FdataMovimento       := query.FieldByName('DATA_MOVIMENTO').AsDateTime;
      transf.Fnovo                := False;

      contaDB.FID             := transf.FIDcontaBancariaDB;
      contaDB.FIDorganizacao  := transf.FIDorganizacao;
      transf.FcontaBancariaDB := TContaBancariaDebitoDAO.obterPorID(contaDB);

      contaCR.FID             := transf.FIDcontaBancariaCR;
      contaCR.FIDorganizacao  := transf.FIDorganizacao;
      transf.FcontaBancariaCR := TContaBancariaCreditoDAO.obterPorID(contaCR);
      end;
    except
      raise Exception.Create('Erro ao converter CBT');
    end;
    Result := transf;

  finally
    FreeAndNil(query);
  end;

end;

class function TContaBancariaTRFDAO.Insert(value: TContaBancariaTRFModel): Boolean;
var
cmdSql:string;
qryInsert : TFDQuery;
sucesso :Boolean;
begin
  sucesso := False;
  dmConexao.conectarBanco;
  qryInsert := TFDQuery.Create(nil);

  try
      cmdSql := ' INSERT INTO CONTA_BANCARIA_TRANSFERENCIA ' +
                ' (ID_CONTA_BANCARIA_TRANSFERENCIA, ID_ORGANIZACAO, '+
                ' ID_CONTA_BANCARIA_CREDITO, ID_CONTA_BANCARIA_DEBITO, '+
                ' ID_TIPO_OPERACAO_BANCARIA, ID_RESPONSAVEL, OBSERVACAO,'+
                ' VALOR, DATA_REGISTRO, DATA_MOVIMENTO, IDENTIFICACAO, '+
                ' ID_USUARIO, ID_LOTE_CONTABIL ) '+
                ' VALUES (:PID, :PIDORGANIZACAO, '+
                ' :PID_CONTA_BANCARIA_CREDITO, :PID_CONTA_BANCARIA_DEBITO, '+
                ' :PIDTOB, :PIDRESP, :POBSERVACAO, '+
                ' :PVALOR, :PDTREGISTRO, :PDTMOVIMENTO, :PIDENTIFICACAO, '+
                ' :PIDUSUARIO, :PIDLOTECONTABIL )';


      qryInsert.Close;
      qryInsert.Connection := dmConexao.conn;
      qryInsert.SQL.Clear;
      qryInsert.SQL.Add(cmdSql);
      qryInsert.ParamByName('PID').AsString                         := value.FID;
      qryInsert.ParamByName('PIDORGANIZACAO').AsString              := value.FIDorganizacao;
      qryInsert.ParamByName('PID_CONTA_BANCARIA_CREDITO').AsString  := value.FIDcontaBancariaCR;
      qryInsert.ParamByName('PID_CONTA_BANCARIA_DEBITO').AsString   := value.FIDcontaBancariaDB;
      qryInsert.ParamByName('PIDTOB').AsString                      := value.FIDTOB;
      qryInsert.ParamByName('PIDRESP').AsString                     := value.FIDResponsavel;
      qryInsert.ParamByName('POBSERVACAO').AsString                 := value.Fobservacao;
      qryInsert.ParamByName('PIDLOTECONTABIL').AsString             := value.FIDloteContabil;
      qryInsert.ParamByName('PIDUSUARIO').AsInteger                 := value.FIDusuario;
      qryInsert.ParamByName('PIDENTIFICACAO').AsString              := value.Fidentificacao;
      qryInsert.ParamByName('PDTREGISTRO').AsDateTime               := value.FdataRegistro;
      qryInsert.ParamByName('PDTMOVIMENTO').AsDateTime              := value.FdataMovimento;
      qryInsert.ParamByName('PVALOR').AsCurrency                    := value.Fvalor;

    if uUtil.Empty(value.FIDloteContabil) then
    begin
      qryInsert.ParamByName('PIDLOTECONTABIL').Value := null;
    end;

    if (value.FIDusuario = 0) then
    begin
      qryInsert.ParamByName('PIDUSUARIO').AsString := uutil.TUserAtual.getUserId;
    end;

     qryInsert.ExecSQL;
     if qryInsert.RowsAffected >0 then begin sucesso := True;
      end;


    Result := sucesso;

  finally
    if Assigned(qryInsert) then
    begin
      FreeAndNil(qryInsert);
    end;
  end;
end;

class function TContaBancariaTRFDAO.obterPorID(value: TContaBancariaTRFModel): TContaBancariaTRFModel;
var
qryPesquisa : TFDQuery;
model: TContaBancariaTRFModel;
begin
dmConexao.conectarBanco;
model     := TContaBancariaTRFModel.Create;
qryPesquisa := TFDQuery.Create(nil);

try

  qryPesquisa.Close;
  qryPesquisa.Connection := dmConexao.conn;
  qryPesquisa.SQL.Clear;
  qryPesquisa.SQL.Add('SELECT * '  );
  qryPesquisa.SQL.Add('FROM CONTA_BANCARIA_TRANSFERENCIA  '  );
  qryPesquisa.SQL.Add('WHERE ID_ORGANIZACAO = :PIDORGANIZACAO  AND  ID_CONTA_BANCARIA_TRANSFERENCIA = :PID '  );

  qryPesquisa.ParamByName('PIDORGANIZACAO').AsString := value.FIDorganizacao;
  qryPesquisa.ParamByName('PID').AsString := value.FID;
  qryPesquisa.Open;

  if not qryPesquisa.IsEmpty then begin
      model     := getModel(qryPesquisa);
  end;

except
raise Exception.Create('Erro ao tentar obter CONTA_BANCARIA_TRANSFERENCIA ');
end;

 Result := model;
end;


class function TContaBancariaTRFDAO.obterTodos(value: string; pDataInicial,  pDataFinal: TDateTime; var combo: TComboBox;  var listaID: TStringList): boolean;
var
qryObterTodos : TFDQuery;
cmdSql :string;
identificacao :string;
begin

dmConexao.conectarBanco;
qryObterTodos := TFDQuery.Create(nil);

cmdSql := ' SELECT CBT.ID_CONTA_BANCARIA_TRANSFERENCIA, CBT.IDENTIFICACAO, CBT.DATA_MOVIMENTO, CBT.VALOR '+
          ' FROM CONTA_BANCARIA_TRANSFERENCIA CBT '+
          ' WHERE   (CBT.ID_ORGANIZACAO = :PIDORGANIZACAO)'+
          ' AND (CBT.DATA_MOVIMENTO BETWEEN :PDTINICIAL AND :PDTFINAL) '+
          ' AND (CBT.ID_LOTE_CONTABIL IS NULL) ';

  listaID := TStringList.Create;
  listaID.Clear;
  listaID.Add('Sem ID');
  combo.Clear;
  combo.Items.Add('<<< Selecione  >>>');

   qryObterTodos.Close;
   qryObterTodos.SQL.Clear;
   qryObterTodos.SQL.Add(cmdSql);
   qryObterTodos.Connection := dmConexao.conn;
   qryObterTodos.ParamByName('PIDORGANIZACAO').AsString := value;
   qryObterTodos.ParamByName('PDTINICIAL').AsDateTime := pDataInicial;
   qryObterTodos.ParamByName('PDTFINAL').AsDateTime := pDataFinal;
   qryObterTodos.Open;

   if not qryObterTodos.IsEmpty then begin
          qryObterTodos.First;

      while not qryObterTodos.Eof do
        begin
          identificacao := qryObterTodos.FieldByName('IDENTIFICACAO').AsString + ' - ' +
              DateToStr(qryObterTodos.FieldByName('DATA_MOVIMENTO').AsDateTime) + ' - R$ ' +
              FormatCurr(',0.00',(qryObterTodos.FieldByName('VALOR').AsCurrency));

          combo.Items.Add(identificacao);
          listaID.Add(qryObterTodos.FieldByName('ID_CONTA_BANCARIA_TRANSFERENCIA').AsString);
          qryObterTodos.Next;
        end;
      qryObterTodos.Close;
      combo.ItemIndex := 0;

   end;


end;

class function TContaBancariaTRFDAO.obterTodos(value: TContaBancariaTRFModel; pDataInicial, pDataFinal: TDateTime): TFDQuery;
var
qryPesquisa : TFDQuery;
begin
dmConexao.conectarBanco;
qryPesquisa := TFDQuery.Create(nil);

      try

        qryPesquisa.Close;
        qryPesquisa.Connection := dmConexao.conn;
        qryPesquisa.SQL.Clear;
        qryPesquisa.SQL.Add('SELECT *  '  );
        qryPesquisa.SQL.Add('FROM CONTA_BANCARIA_TRANSFERENCIA  '  );
        qryPesquisa.SQL.Add('WHERE (ID_ORGANIZACAO = :PIDORGANIZACAO)  AND (DATA_MOVIMENTO  BETWEEN :PDTINICIAL AND :PDTFINAL )');
        qryPesquisa.ParamByName('PIDORGANIZACAO').AsString := value.FIDorganizacao;
        qryPesquisa.ParamByName('PDTINICIAL').AsDateTime := pDataInicial;
        qryPesquisa.ParamByName('PDTFINAL').AsDateTime := pDataFinal;

        qryPesquisa.Open;


      except
      raise Exception.Create('Erro ao tentar obter TRANSFERÊNCIAS NO PERIODO  ');
      end;

 Result := qryPesquisa;
end;


class function TContaBancariaTRFDAO.transfereEntreContas( value: TContaBancariaTRFModel): Boolean;
 var
 sucesso : Boolean;
 contaDB, contaCR :string;
begin
sucesso := False;
contaDB:='NC';
contaCR:='NC';

  if not dmConexao.conn.InTransaction then
         dmConexao.conn.StartTransaction;

  try

    if not uutil.Empty(value.FcontaBancariaDB.FID) then
    begin
     contaDB:=value.FcontaBancariaDB.FcontaBancaria;
      sucesso := TContaBancariaDebitoDAO.Insert(value.FcontaBancariaDB);
    end;

    if not uutil.Empty(value.FcontaBancariaCR.FID) then
    begin
      contaCR:=value.FcontaBancariaCR.FcontaBancaria;
      sucesso := TContaBancariaCreditoDAO.Insert(value.FcontaBancariaCR);
    end;

    if sucesso then
    begin
      Insert(value);

    end;


      if dmConexao.conn.InTransaction then
         dmConexao.conn.CommitRetaining;

       TMDDAO.registroMD(value.FIDorganizacao, pTable, 'TRF', 'TRF DA ' + value.FcontaBancariaDB.FcontaBancaria.Fconta + '  para ' + value.FcontaBancariaCR.FcontaBancaria.Fconta, 'TRANSF');

    except
      if dmConexao.conn.InTransaction then
        dmConexao.conn.RollbackRetaining;

    end;

    Result := sucesso;

end;

class function TContaBancariaTRFDAO.Update(value: TContaBancariaTRFModel): Boolean;
var
cmdSql:string;
qryInsert : TFDQuery;
sucesso :Boolean;
begin
  sucesso := False;
  dmConexao.conectarBanco;
  qryInsert := TFDQuery.Create(nil);

  try
    try
    cmdSql := ' UPDATE CONTA_BANCARIA_TRANSFERENCIA ' +
              '  SET ID_CONTA_BANCARIA_CREDITO    = :PID_CONTA_BANCARIA_CREDITO,'+
              '      ID_CONTA_BANCARIA_DEBITO     = :PID_CONTA_BANCARIA_DEBITO,'+
              '      ID_TIPO_OPERACAO_BANCARIA    = :PIDTOB,'+
              '      ID_RESPONSAVEL               = :PIDRESP,'+
              '      OBSERVACAO                   = :POBSERVACAO,'+
              '      VALOR                        = :PVALOR,'+
              '      DATA_MOVIMENTO               = :PDTMOVIMENTO,'+
              '      IDENTIFICACAO                = :PIDENTIFICACAO,'+
              '      ID_USUARIO                   = :PIDUSUARIO,'+
              '      ID_LOTE_CONTABIL             = :PIDLOTECONTABIL'+
              '      WHERE (ID_CONTA_BANCARIA_TRANSFERENCIA = :PID) AND (ID_ORGANIZACAO = :PIDORGANIZACAO)' ;


      qryInsert.Close;
      qryInsert.Connection := dmConexao.conn;
      qryInsert.SQL.Clear;
      qryInsert.SQL.Add(cmdSql);
      qryInsert.ParamByName('PID').AsString                         := value.FID;
      qryInsert.ParamByName('PIDORGANIZACAO').AsString              := value.FIDorganizacao;
      qryInsert.ParamByName('PID_CONTA_BANCARIA_CREDITO').AsString  := value.FIDcontaBancariaCR;
      qryInsert.ParamByName('PID_CONTA_BANCARIA_DEBITO').AsString   := value.FIDcontaBancariaDB;
      qryInsert.ParamByName('PIDTOB').AsString                      := value.FIDTOB;
      qryInsert.ParamByName('PIDRESP').AsString                     := value.FIDResponsavel;
      qryInsert.ParamByName('POBSERVACAO').AsString                 := value.Fobservacao;
      qryInsert.ParamByName('PIDLOTECONTABIL').AsString             := value.FIDloteContabil;
      qryInsert.ParamByName('PIDUSUARIO').AsInteger                 := value.FIDusuario;
      qryInsert.ParamByName('PIDENTIFICACAO').AsString              := value.Fidentificacao;
//      qryInsert.ParamByName('PDTREGISTRO').AsDateTime               := value.FdataRegistro;
      qryInsert.ParamByName('PDTMOVIMENTO').AsDateTime              := value.FdataMovimento;
      qryInsert.ParamByName('PVALOR').AsCurrency                    := value.Fvalor;

    if uUtil.Empty(value.FIDloteContabil) then
    begin
      qryInsert.ParamByName('PIDLOTECONTABIL').Value := null;
    end;

    if (value.FIDusuario = 0) then
    begin
      qryInsert.ParamByName('PIDUSUARIO').AsString := uutil.TUserAtual.getUserId;
    end;

     qryInsert.ExecSQL;
     if qryInsert.RowsAffected >0 then begin sucesso := True; end;

    Result := sucesso;
    except
      sucesso := False;
      raise Exception.Create('Erro ao tentar inserir CBT');
    end;

    Result := sucesso;
  finally
    if Assigned(qryInsert) then
    begin
      FreeAndNil(qryInsert);

    end;

  end;
end;


end.
